<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veda Kirana - POS (Batch System)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .view { display: none; }
        .active-view { display: block; }
        .nav-link { cursor: pointer; }
        .nav-link.active { background-color: #1e40af; color: white; }
        @media print {
            body * { visibility: hidden; }
            #receipt-print-area, #receipt-print-area * { visibility: visible; }
            #receipt-print-area { position: absolute; left: 0; top: 0; width: 100%; font-family: 'Courier New', Courier, monospace; font-size: 10px; }
            @page { size: 80mm auto; margin: 2mm; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="auth-screen" class="min-h-screen flex items-center justify-center bg-gray-900"><div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md"><div class="text-center mb-6"><h1 class="text-3xl font-bold text-gray-800">VEDA KIRANA POS</h1><p class="text-gray-500">Welcome! Please sign in to continue.</p></div><form id="auth-form" class="space-y-4"><input type="email" id="email" placeholder="Email" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><input type="password" id="password" placeholder="Password" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><div id="auth-error" class="text-red-500 text-sm hidden"></div><div class="flex space-x-2"><button type="button" id="signin-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Sign In</button><button type="button" id="signup-btn" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Sign Up</button></div></form><div class="text-center my-4"><span class="text-gray-400">OR</span></div><button id="google-signin-btn" class="w-full flex items-center justify-center bg-white border text-gray-700 py-2 rounded-lg hover:bg-gray-50"><i class="fab fa-google mr-2"></i> Continue with Google</button></div></div>
    <div id="app-screen" class="hidden">
        <div class="flex h-screen bg-gray-200">
            <aside class="w-64 bg-gray-800 text-white flex flex-col"><div class="p-4 border-b border-gray-700 text-center"><h1 class="text-2xl font-bold">Veda Kirana</h1></div><nav class="flex-1 p-2 space-y-2"><a data-view="dashboard" class="nav-link active flex items-center p-3 rounded-lg hover:bg-gray-700"><i class="fas fa-chart-pie mr-3 w-5"></i> Dashboard</a><a data-view="billing" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700"><i class="fas fa-cash-register mr-3 w-5"></i> Billing</a><a data-view="inventory" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700"><i class="fas fa-boxes-stacked mr-3 w-5"></i> Inventory</a><a data-view="history" class="nav-link flex items-center p-3 rounded-lg hover:bg-gray-700"><i class="fas fa-history mr-3 w-5"></i> Past History</a></nav><div class="p-4 border-t border-gray-700"><button id="logout-btn" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 flex items-center justify-center"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button></div></aside>
            <main class="flex-1 p-6 overflow-y-auto">
                <div class="bg-white p-4 rounded-lg shadow-md mb-6"><h2 id="welcome-message" class="text-xl font-semibold text-gray-700">Welcome back!</h2></div>
                <section id="dashboard-view" class="view active-view"><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"><div class="bg-blue-500 text-white p-6 rounded-lg shadow-lg"><h3 class="text-lg">Today's Sales</h3><p id="total-sales" class="text-4xl font-bold">₹0</p></div><div class="bg-green-500 text-white p-6 rounded-lg shadow-lg"><h3 class="text-lg">Today's Transactions</h3><p id="total-transactions" class="text-4xl font-bold">0</p></div><div id="low-stock-card" class="bg-yellow-500 text-white p-6 rounded-lg shadow-lg cursor-pointer hover:bg-yellow-600"><h3 class="text-lg">Low Stock Items (&lt;10)</h3><p id="low-stock-items" class="text-4xl font-bold">0</p></div></div><div><button id="ai-summary-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center"><i class="fas fa-robot mr-2"></i> Get AI Sales Summary</button></div></section>
                <section id="billing-view" class="view"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md"><div class="relative mb-4"><div class="relative flex-grow"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input type="text" id="barcode-search" placeholder="Scan Barcode or Search by Name..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div id="search-results" class="absolute top-full left-0 right-0 bg-white border rounded-b-lg shadow-lg z-10 hidden max-h-60 overflow-y-auto"></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-100"><th class="p-3">Product</th><th class="p-3">Price</th><th class="p-3 text-center">Quantity</th><th class="p-3">Total</th><th class="p-3 text-center">Action</th></tr></thead><tbody id="bill-items-body"><tr id="bill-placeholder"><td colspan="5" class="text-center p-6 text-gray-500">Scan an item to begin...</td></tr></tbody></table></div></div><div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-2xl font-bold mb-4 border-b pb-2">Bill Summary</h3><div class="space-y-3 mb-4 text-lg"><div class="flex justify-between"><span>Subtotal:</span> <span id="bill-subtotal">₹0.00</span></div><div class="flex justify-between"><span>Store Discount (2%):</span> <span id="bill-discount" class="text-red-500">-₹0.00</span></div><div class="flex justify-between font-bold text-2xl border-t pt-3"><span>Total:</span> <span id="bill-total">₹0.00</span></div></div><div class="space-y-4 mb-4"><input type="text" id="customer-name" placeholder="Customer Name (Optional)" class="w-full px-4 py-2 border rounded-lg"><input type="text" id="customer-phone" placeholder="Customer Phone (Optional)" class="w-full px-4 py-2 border rounded-lg"></div><div class="space-y-2"><button id="complete-sale-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-green-700" disabled>Complete Sale</button><button id="cancel-sale-btn" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">Cancel Sale</button></div><div class="mt-4"><button id="recipe-ai-btn" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 flex items-center justify-center"><i class="fas fa-utensils mr-2"></i> Get Recipe Idea</button></div></div></div></section>
                <section id="inventory-view" class="view"><div class="bg-white p-6 rounded-lg shadow-md"><div class="flex justify-between items-center mb-4"><div id="inventory-header"><h2 class="text-2xl font-bold">Manage Inventory</h2></div><div class="space-x-2"><button id="add-product-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add New Product</button><button id="receive-stock-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Receive Stock</button></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-100"><th class="p-3">Name</th><th class="p-3">Barcode</th><th class="p-3">Category</th><th class="p-3">Total Stock</th><th class="p-3">Batches</th><th class="p-3 text-center">Actions</th></tr></thead><tbody id="inventory-table-body"></tbody></table></div></div></section>
                <section id="history-view" class="view"><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-bold mb-4">Sales History</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end bg-gray-50 p-4 rounded-lg mb-4"><div><label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label><input type="date" id="start-date" class="mt-1 block w-full p-2 border rounded-md"></div><div><label for="end-date" class="block text-sm font-medium text-gray-700">End Date</label><input type="date" id="end-date" class="mt-1 block w-full p-2 border rounded-md"></div><div><label for="history-search" class="block text-sm font-medium text-gray-700">Customer Name</label><input type="text" id="history-search" placeholder="Search by name..." class="mt-1 block w-full p-2 border rounded-md"></div><div class="flex space-x-2"><button id="filter-by-date-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Filter</button><button id="clear-filter-btn" class="w-full bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Clear</button></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-100"><th class="p-3">Date</th><th class="p-3">Customer</th><th class="p-3">Items</th><th class="p-3">Total</th><th class="p-3">Actions</th></tr></thead><tbody id="history-table-body"></tbody></table></div></div></section>
            </main>
        </div>
    </div>
    <div id="add-product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-lg"><h2 class="text-2xl font-bold mb-6">Add a New Product</h2><form id="add-product-form" class="space-y-4"><p class="text-sm text-gray-600">This creates a new product with zero stock. Use "Receive Stock" to add inventory.</p><input type="text" id="new-product-name" placeholder="Product Name" required class="w-full p-2 border rounded"><input type="text" id="new-product-barcode" placeholder="Barcode (Optional, must be unique)" class="w-full p-2 border rounded"><div><label class="block font-medium">Category</label><select id="new-product-category" class="w-full p-2 border rounded mt-1"><option value="Kirana">Kirana</option><option value="General">General</option></select></div><div class="flex justify-end gap-4 pt-4"><button type="button" id="cancel-add-product-modal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Create Product</button></div></form></div></div>
    <div id="receive-stock-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-xl"><h2 class="text-2xl font-bold mb-6">Receive New Stock Batch</h2><form id="receive-stock-form" class="space-y-4"><div class="relative"><label class="block font-medium">Search for an Existing Product</label><input type="text" id="product-search-input" placeholder="Search by name or barcode..." class="w-full mt-1 p-2 border rounded"><div id="product-search-results" class="absolute z-10 w-full bg-white border rounded shadow-lg hidden max-h-48 overflow-y-auto"></div></div><div id="batch-details-fields" class="hidden pt-4 border-t space-y-3"><h3 class="text-lg font-semibold">Adding Batch to: <span id="selected-product-name" class="text-blue-700"></span></h3><div class="grid grid-cols-3 gap-4"><div><label class="block font-medium">Quantity Received</label><input type="number" id="batch-quantity" placeholder="e.g., 50" required class="w-full p-2 border rounded"></div><div><label class="block font-medium">Purchase Price (Your Cost)</label><input type="number" step="0.01" id="batch-purchase-price" placeholder="e.g., 150.00" required class="w-full p-2 border rounded"></div><div><label class="block font-medium">Selling Price (For Customers)</label><input type="number" step="0.01" id="batch-selling-price" placeholder="e.g., 180.00" required class="w-full p-2 border rounded"></div></div></div><div class="flex justify-end gap-4 pt-4"><button type="button" id="cancel-receive-stock-modal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button type="submit" id="confirm-batch-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg" disabled>Save Batch</button></div></form></div></div>
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm"><div id="receipt-print-area" class="text-black text-xs"><div class="text-center mb-4"><h2 class="text-lg font-bold">VEDA KIRANA AND GENERAL STORE</h2><p>Ratna Complex, 509338</p><p>Phone: 8309913409</p><p id="receipt-date" class="mt-2 text-xs"></p><p id="receipt-customer" class="text-xs"></p></div><div class="border-t border-b border-dashed border-black my-2 py-2"><div class="grid grid-cols-12 gap-1 font-bold"><div class="col-span-5">Item</div><div class="col-span-2 text-right">Qty</div><div class="col-span-2 text-right">Price</div><div class="col-span-3 text-right">Total</div></div><div id="receipt-items" class="mt-1 space-y-1"></div></div><div class="space-y-1 mt-2 text-right"><p>Subtotal: <span id="receipt-subtotal"></span></p><p>Discount: <span id="receipt-discount"></span></p><p class="font-bold text-sm">TOTAL: <span id="receipt-total"></span></p></div><p class="text-center mt-4">Thank you for your visit!</p></div><div class="flex justify-end gap-4 mt-6"><button id="cancel-receipt-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Cancel</button><button id="confirm-print-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg">Confirm & Print</button></div></div></div>
    <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-2xl"><h2 id="ai-modal-title" class="text-2xl font-bold mb-4">AI Analysis</h2><div id="ai-modal-content" class="bg-gray-100 p-4 rounded-lg max-h-96 overflow-y-auto prose"></div><div class="flex justify-end mt-6"><button id="close-ai-modal" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Close</button></div></div></div>
    <div id="history-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-lg"><h2 class="text-2xl font-bold mb-2">Transaction Details</h2><p id="history-detail-customer" class="text-gray-600 mb-1"></p><p id="history-detail-date" class="text-gray-600 mb-4"></p><div class="max-h-80 overflow-y-auto border-t pt-4"><table class="w-full text-left"><thead><tr class="bg-gray-50"><th class="p-2">Item</th><th class="p-2">Price</th><th class="p-2">Qty</th><th class="p-2 text-right">Total</th></tr></thead><tbody id="history-detail-items"></tbody></table></div><div class="flex justify-end mt-6"><button id="close-history-detail-modal" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Close</button></div></div></div>

<script type="module">
    const SUPABASE_URL = "https://rthuzwhtwuhbzdokwgme.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0aHV6d2h0d3VoYnpkb2t3Z21lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDQyODYsImV4cCI6MjA3MzgyMDI4Nn0.zs17CD9KBZmuVjhQDs0EP1ut9fy-TkalWy5DE63SHgk";
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUser = null, inventoryCache = [], currentBill = [], salesHistoryCache = [], selectedProductForBatch = null;

    const DOMElements = {
        authScreen: document.getElementById('auth-screen'), appScreen: document.getElementById('app-screen'), authForm: document.getElementById('auth-form'),
        emailInput: document.getElementById('email'), passwordInput: document.getElementById('password'), authError: document.getElementById('auth-error'),
        signinBtn: document.getElementById('signin-btn'), signupBtn: document.getElementById('signup-btn'), googleSigninBtn: document.getElementById('google-signin-btn'),
        logoutBtn: document.getElementById('logout-btn'), welcomeMessage: document.getElementById('welcome-message'), navLinks: document.querySelectorAll('.nav-link'),
        views: document.querySelectorAll('.view'), totalSales: document.getElementById('total-sales'), totalTransactions: document.getElementById('total-transactions'),
        lowStockItems: document.getElementById('low-stock-items'), lowStockCard: document.getElementById('low-stock-card'), aiSummaryBtn: document.getElementById('ai-summary-btn'),
        inventoryTableBody: document.getElementById('inventory-table-body'), inventoryHeader: document.getElementById('inventory-header'),
        addProductBtn: document.getElementById('add-product-btn'),
        receiveStockBtn: document.getElementById('receive-stock-btn'),
        addProductModal: document.getElementById('add-product-modal'), addProductForm: document.getElementById('add-product-form'),
        newProductName: document.getElementById('new-product-name'), newProductBarcode: document.getElementById('new-product-barcode'),
        newProductCategory: document.getElementById('new-product-category'), cancelAddProductModalBtn: document.getElementById('cancel-add-product-modal'),
        receiveStockModal: document.getElementById('receive-stock-modal'), receiveStockForm: document.getElementById('receive-stock-form'),
        productSearchInput: document.getElementById('product-search-input'), productSearchResults: document.getElementById('product-search-results'),
        batchDetailsFields: document.getElementById('batch-details-fields'), selectedProductName: document.getElementById('selected-product-name'),
        batchQuantity: document.getElementById('batch-quantity'), batchPurchasePrice: document.getElementById('batch-purchase-price'),
        batchSellingPrice: document.getElementById('batch-selling-price'), cancelReceiveStockModal: document.getElementById('cancel-receive-stock-modal'),
        confirmBatchBtn: document.getElementById('confirm-batch-btn'),
        barcodeSearchInput: document.getElementById('barcode-search'), searchResults: document.getElementById('search-results'),
        billItemsBody: document.getElementById('bill-items-body'), billPlaceholder: document.getElementById('bill-placeholder'), billSubtotal: document.getElementById('bill-subtotal'),
        billDiscount: document.getElementById('bill-discount'), billTotal: document.getElementById('bill-total'), customerNameInput: document.getElementById('customer-name'),
        customerPhoneInput: document.getElementById('customer-phone'), completeSaleBtn: document.getElementById('complete-sale-btn'), cancelSaleBtn: document.getElementById('cancel-sale-btn'),
        recipeAiBtn: document.getElementById('recipe-ai-btn'), receiptModal: document.getElementById('receipt-modal'), receiptDate: document.getElementById('receipt-date'),
        receiptCustomer: document.getElementById('receipt-customer'), receiptItems: document.getElementById('receipt-items'), receiptSubtotal: document.getElementById('receipt-subtotal'),
        receiptDiscount: document.getElementById('receipt-discount'), receiptTotal: document.getElementById('receipt-total'), cancelReceiptBtn: document.getElementById('cancel-receipt-btn'),
        confirmPrintBtn: document.getElementById('confirm-print-btn'), historyTableBody: document.getElementById('history-table-body'), historySearchInput: document.getElementById('history-search'),
        historyDetailModal: document.getElementById('history-detail-modal'), historyDetailCustomer: document.getElementById('history-detail-customer'),
        historyDetailDate: document.getElementById('history-detail-date'), historyDetailItems: document.getElementById('history-detail-items'),
        closeHistoryDetailModalBtn: document.getElementById('close-history-detail-modal'),
        aiModal: document.getElementById('ai-modal'), aiModalTitle: document.getElementById('ai-modal-title'), aiModalContent: document.getElementById('ai-modal-content'),
        closeAiModalBtn: document.getElementById('close-ai-modal'),
        startDateInput: document.getElementById('start-date'), endDateInput: document.getElementById('end-date'),
        filterByDateBtn: document.getElementById('filter-by-date-btn'), clearFilterBtn: document.getElementById('clear-filter-btn'),
    };
    
    document.addEventListener('DOMContentLoaded', checkUser);
    async function checkUser() { const { data: { session } } = await db.auth.getSession(); if (session) { currentUser = session.user; showAppScreen(); } else { showAuthScreen(); } }
    db.auth.onAuthStateChange((event, session) => { if (event === 'SIGNED_IN') { currentUser = session.user; showAppScreen(); } else if (event === 'SIGNED_OUT') { currentUser = null; showAuthScreen(); } });
    async function handleSignIn() { const { data, error } = await db.auth.signInWithPassword({ email: DOMElements.emailInput.value, password: DOMElements.passwordInput.value }); if (error) { DOMElements.authError.textContent = error.message; DOMElements.authError.classList.remove('hidden'); } else if (data.user) { DOMElements.authError.classList.add('hidden'); currentUser = data.user; showAppScreen(); } }
    async function handleSignUp() { const { error } = await db.auth.signUp({ email: DOMElements.emailInput.value, password: DOMElements.passwordInput.value }); if (error) { DOMElements.authError.textContent = error.message; DOMElements.authError.classList.remove('hidden'); } else { alert('Sign up successful! Please check your email to confirm.'); } }
    async function handleGoogleSignIn() { await db.auth.signInWithOAuth({ provider: 'google' }); }
    async function handleSignOut() { await db.auth.signOut(); }
    function showAppScreen() { DOMElements.authScreen.classList.add('hidden'); DOMElements.appScreen.classList.remove('hidden'); const displayName = currentUser.email.split('@')[0]; DOMElements.welcomeMessage.textContent = `Welcome back, ${displayName}!`; loadDashboardData(); loadInventory(); loadSalesHistory(); }
    function showAuthScreen() { DOMElements.authScreen.classList.remove('hidden'); DOMElements.appScreen.classList.add('hidden'); }

    function switchView(viewId, params = {}) { DOMElements.views.forEach(view => view.classList.remove('active-view')); document.getElementById(`${viewId}-view`).classList.add('active-view'); DOMElements.navLinks.forEach(link => link.classList.toggle('active', link.dataset.view === viewId)); if (viewId === 'billing') { setTimeout(() => DOMElements.barcodeSearchInput.focus(), 0); } if (viewId === 'inventory') { renderInventoryTable(params); } if (viewId === 'history') { loadSalesHistory(); } }
    async function loadDashboardData() { const today = new Date(); today.setHours(0, 0, 0, 0); const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1); const { data: sales, error: salesError } = await db.from('sales').select('total').gte('created_at', today.toISOString()).lt('created_at', tomorrow.toISOString()); if (salesError) { console.error('Error fetching dashboard sales:', salesError); return; } const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0); DOMElements.totalSales.textContent = `₹${totalSales.toFixed(2)}`; DOMElements.totalTransactions.textContent = sales.length; const lowStockCount = inventoryCache.filter(p => p.totalStock > 0 && p.totalStock < 10).length; DOMElements.lowStockItems.textContent = lowStockCount; }
    
    async function loadInventory() { const { data, error } = await db.from('products').select(`*, stock_batches(*)`).order('created_at', { ascending: true }).order('received_at', { foreignTable: 'stock_batches', ascending: true }); if (error) { console.error('Error loading inventory:', error); return; } inventoryCache = data.map(product => { const activeBatches = product.stock_batches.filter(b => b.quantity_remaining > 0); const totalStock = activeBatches.reduce((sum, b) => sum + b.quantity_remaining, 0); return { ...product, batches: activeBatches, totalStock }; }); renderInventoryTable(); await loadDashboardData(); }
    function renderInventoryTable(filters = {}) { let itemsToRender = inventoryCache; if (filters.lowStockOnly) { itemsToRender = inventoryCache.filter(p => p.totalStock > 0 && p.totalStock < 10); DOMElements.inventoryHeader.innerHTML = `<div><h2 class="text-2xl font-bold text-yellow-600">Showing Low Stock Items</h2><button id="show-all-btn" class="text-sm text-blue-500 hover:underline mt-1">Show All Items</button></div>`; } else { DOMElements.inventoryHeader.innerHTML = `<h2 class="text-2xl font-bold">Manage Inventory</h2>`; } DOMElements.inventoryTableBody.innerHTML = ''; if (itemsToRender.length === 0) { DOMElements.inventoryTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-6 text-gray-500">No products found.</td></tr>`; return; } itemsToRender.forEach(product => { const row = `<tr class="border-b"><td class="p-3 font-semibold">${product.name}</td><td class="p-3 font-mono">${product.barcode || 'N/A'}</td><td class="p-3">${product.category}</td><td class="p-3 text-lg font-bold ${product.totalStock < 10 && product.totalStock > 0 ? 'text-red-500' : ''}">${product.totalStock}</td><td class="p-3 text-xs">${product.batches.length}</td><td class="p-3 text-center"><button class="delete-product-btn text-red-500 hover:text-red-700" data-id="${product.id}" data-name="${product.name}"><i class="fas fa-trash-alt"></i></button></td></tr>`; DOMElements.inventoryTableBody.insertAdjacentHTML('beforeend', row); }); }
    async function handleDeleteProduct(productId, productName) { if (!confirm(`Are you sure you want to delete "${productName}"?\nThis will remove the product and all of its stock batches. This action cannot be undone.`)) { return; } const { error } = await db.from('products').delete().eq('id', productId); if (error) { alert('Error deleting product: ' + error.message); } else { alert(`"${productName}" was deleted successfully.`); loadInventory(); } }
    function showAddProductModal() { DOMElements.addProductForm.reset(); DOMElements.addProductModal.classList.remove('hidden'); DOMElements.newProductName.focus(); }
    function hideAddProductModal() { DOMElements.addProductModal.classList.add('hidden'); }
    async function handleAddProductSubmit(e) { e.preventDefault(); const barcode = DOMElements.newProductBarcode.value.trim(); if (barcode && inventoryCache.find(p => p.barcode === barcode)) { alert(`Error: Barcode '${barcode}' already exists.`); return; } const newProductData = { name: DOMElements.newProductName.value, barcode: barcode || null, category: DOMElements.newProductCategory.value, user_id: currentUser.id }; const { error } = await db.from('products').insert(newProductData); if (error) { alert('Error creating product: ' + error.message); return; } alert(`Product "${newProductData.name}" created successfully!`); hideAddProductModal(); loadInventory(); }
    function showReceiveStockModal() { selectedProductForBatch = null; DOMElements.receiveStockForm.reset(); DOMElements.batchDetailsFields.classList.add('hidden'); DOMElements.confirmBatchBtn.disabled = true; DOMElements.receiveStockModal.classList.remove('hidden'); DOMElements.productSearchInput.focus(); }
    function hideReceiveStockModal() { DOMElements.receiveStockModal.classList.add('hidden'); }
    function handleProductSearch() { const term = DOMElements.productSearchInput.value.toLowerCase().trim(); if (term.length < 2) { DOMElements.productSearchResults.classList.add('hidden'); return; } const results = inventoryCache.filter(p => p.name.toLowerCase().includes(term) || (p.barcode && p.barcode.includes(term))); DOMElements.productSearchResults.innerHTML = ''; results.forEach(p => { const div = document.createElement('div'); div.className = 'p-2 hover:bg-gray-100 cursor-pointer'; div.textContent = `${p.name} (${p.barcode || 'No Barcode'})`; div.onclick = () => selectProductForBatch(p); DOMElements.productSearchResults.appendChild(div); }); DOMElements.productSearchResults.classList.remove('hidden'); }
    function selectProductForBatch(product) { selectedProductForBatch = product; DOMElements.productSearchResults.classList.add('hidden'); DOMElements.productSearchInput.value = product.name; DOMElements.batchDetailsFields.classList.remove('hidden'); DOMElements.confirmBatchBtn.disabled = false; DOMElements.selectedProductName.textContent = product.name; DOMElements.batchQuantity.focus(); }
    async function handleReceiveStockSubmit(e) { e.preventDefault(); if (!selectedProductForBatch) { alert("Please select a product first."); return; } const sellingPrice = parseFloat(DOMElements.batchSellingPrice.value); const batchData = { product_id: selectedProductForBatch.id, user_id: currentUser.id, quantity_received: parseInt(DOMElements.batchQuantity.value), quantity_remaining: parseInt(DOMElements.batchQuantity.value), purchase_price: parseFloat(DOMElements.batchPurchasePrice.value), selling_price: sellingPrice, }; const { error } = await db.from('stock_batches').insert(batchData); if (error) { alert('Error saving batch: ' + error.message); return; } await db.from('products').update({ latest_selling_price: sellingPrice }).eq('id', selectedProductForBatch.id); alert('New batch received successfully!'); hideReceiveStockModal(); loadInventory(); }
    function findProducts(term) { const lowerCaseTerm = term.toLowerCase(); return inventoryCache.filter(p => p.name.toLowerCase().includes(lowerCaseTerm) || (p.barcode && p.barcode.includes(term))); }
    function addProductToBill(product) { if (product.totalStock <= 0) { alert(`${product.name} is out of stock.`); return; } const oldestBatch = product.batches[0]; const existingItem = currentBill.find(item => item.batch_id === oldestBatch.id); if (existingItem) { if (existingItem.quantity < oldestBatch.quantity_remaining) { existingItem.quantity++; } else { alert(`Stock limit for this batch reached. Scan again to pull from the next batch.`); } } else { currentBill.push({ product_id: product.id, batch_id: oldestBatch.id, name: product.name, quantity: 1, price: oldestBatch.selling_price, max_qty: oldestBatch.quantity_remaining, category: product.category, }); } renderBill(); clearAndFocusSearch(); }
    function renderBill() { DOMElements.billItemsBody.innerHTML = ''; DOMElements.billPlaceholder.classList.toggle('hidden', currentBill.length > 0); currentBill.forEach(item => { const row = `<tr class="border-b" data-batch-id="${item.batch_id}"><td class="p-3">${item.name} <span class="text-xs text-gray-500">(Batch #${item.batch_id.substring(0,4)})</span></td><td class="p-3">₹${item.price.toFixed(2)}</td><td class="p-3"><div class="flex items-center justify-center"><button class="decrement-qty-btn bg-gray-200 rounded-full w-6 h-6 flex items-center justify-center">-</button><span class="px-3 font-semibold">${item.quantity}</span><button class="increment-qty-btn bg-gray-200 rounded-full w-6 h-6 flex items-center justify-center">+</button></div></td><td class="p-3 font-semibold">₹${(item.price * item.quantity).toFixed(2)}</td><td class="p-3 text-center"><button class="remove-item-btn text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></td></tr>`; DOMElements.billItemsBody.insertAdjacentHTML('beforeend', row); }); updateBillSummary(); DOMElements.completeSaleBtn.disabled = currentBill.length === 0; }
    function updateBillSummary() { const subtotal = currentBill.reduce((sum, item) => sum + (item.price * item.quantity), 0); const discount = currentBill.filter(item => item.category === 'General').reduce((sum, item) => sum + (item.price * item.quantity), 0) * 0.02; DOMElements.billSubtotal.textContent = `₹${subtotal.toFixed(2)}`; DOMElements.billDiscount.textContent = `-₹${discount.toFixed(2)}`; DOMElements.billTotal.textContent = `₹${(subtotal - discount).toFixed(2)}`; }
    function handleBillQuantityChange(batchId, change) { const item = currentBill.find(i => i.batch_id === batchId); if (!item) return; const newQuantity = item.quantity + change; if (change > 0) { if (newQuantity <= item.max_qty) { item.quantity = newQuantity; } else { alert(`Stock limit for this batch (${item.max_qty}) reached.`); } } else { if (newQuantity > 0) { item.quantity = newQuantity; } else { handleRemoveItem(batchId); } } renderBill(); }
    function handleRemoveItem(batchId) { currentBill = currentBill.filter(item => item.batch_id !== batchId); renderBill(); }
    function cancelSale() { currentBill = []; renderBill(); DOMElements.customerNameInput.value = ''; DOMElements.customerPhoneInput.value = ''; }
    function clearAndFocusSearch() { DOMElements.barcodeSearchInput.value = ''; DOMElements.searchResults.classList.add('hidden'); DOMElements.barcodeSearchInput.focus(); }
    function handleBarcodeSearch(event) { const searchTerm = DOMElements.barcodeSearchInput.value.trim(); if (event.key === 'Enter') { if (!searchTerm) return; let results = findProducts(searchTerm); if (results.length === 1) { addProductToBill(results[0]); } else if (results.length > 1) { alert('Multiple products found, please be more specific.'); } else { alert('Product not found.'); } } else { if (searchTerm.length < 1) { DOMElements.searchResults.classList.add('hidden'); return; } renderSearchResults(findProducts(searchTerm)); } }
    function renderSearchResults(results) { if (results.length === 0) { DOMElements.searchResults.classList.add('hidden'); return; } DOMElements.searchResults.innerHTML = results.map(p => `<div class="p-3 hover:bg-gray-100 cursor-pointer search-result-item" data-id="${p.id}"><p class="font-semibold">${p.name}</p><p class="text-sm text-gray-500">Barcode: ${p.barcode || 'N/A'} | Stock: ${p.totalStock}</p></div>`).join(''); DOMElements.searchResults.classList.remove('hidden'); }
    function showReceiptPreview() { DOMElements.receiptDate.textContent = new Date().toLocaleString(); DOMElements.receiptCustomer.textContent = DOMElements.customerNameInput.value ? `Customer: ${DOMElements.customerNameInput.value}` : ''; DOMElements.receiptItems.innerHTML = currentBill.map(item => `<div class="grid grid-cols-12 gap-1"><div class="col-span-5">${item.name}</div><div class="col-span-2 text-right">${item.quantity}</div><div class="col-span-2 text-right">@${item.price.toFixed(2)}</div><div class="col-span-3 text-right">₹${(item.price * item.quantity).toFixed(2)}</div></div>`).join(''); DOMElements.receiptSubtotal.textContent = DOMElements.billSubtotal.textContent; DOMElements.receiptDiscount.textContent = DOMElements.billDiscount.textContent; DOMElements.receiptTotal.textContent = DOMElements.billTotal.textContent; DOMElements.receiptModal.classList.remove('hidden'); }
    async function handleConfirmAndPrint() { const subtotal = parseFloat(DOMElements.billSubtotal.textContent.replace('₹', '')); const discount = parseFloat(DOMElements.billDiscount.textContent.replace('-₹', '')); const total = parseFloat(DOMElements.billTotal.textContent.replace('₹', '')); const saleData = { user_id: currentUser.id, items: currentBill, subtotal, discount, total, customer_name: DOMElements.customerNameInput.value.trim(), customer_phone: DOMElements.customerPhoneInput.value.trim() }; const { error: saleError } = await db.from('sales').insert([saleData]); if (saleError) { alert('Error saving sale: ' + saleError.message); return; } const batchUpdates = currentBill.map(item => db.from('stock_batches').update({ quantity_remaining: item.max_qty - item.quantity }).eq('id', item.batch_id)); await Promise.all(batchUpdates); window.print(); DOMElements.receiptModal.classList.add('hidden'); cancelSale(); loadInventory(); loadSalesHistory(); }
    async function loadSalesHistory(filters = {}) { let query = db.from('sales').select('*'); if (filters.startDate) { query = query.gte('created_at', filters.startDate); } if (filters.endDate) { const nextDay = new Date(filters.endDate); nextDay.setDate(nextDay.getDate() + 1); query = query.lt('created_at', nextDay.toISOString().split('T')[0]); } if (filters.customerName) { query = query.ilike('customer_name', `%${filters.customerName}%`); } if (!filters.startDate && !filters.endDate) { const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); query = query.gte('created_at', thirtyDaysAgo.toISOString()); } const { data, error } = await query.order('created_at', { ascending: false }); if (error) { console.error('Error fetching sales history:', error); salesHistoryCache = []; } else { salesHistoryCache = data; } renderHistoryTable(); }
    function renderHistoryTable() { DOMElements.historyTableBody.innerHTML = ''; if (salesHistoryCache.length === 0) { DOMElements.historyTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-6 text-gray-500">No sales found for the selected criteria.</td></tr>`; return; } salesHistoryCache.forEach(sale => { const row = `<tr class="border-b hover:bg-gray-50 cursor-pointer history-row" data-id="${sale.id}"><td class="p-3">${new Date(sale.created_at).toLocaleString()}</td><td class="p-3">${sale.customer_name || 'N/A'}</td><td class="p-3">${sale.items.length}</td><td class="p-3 font-semibold">₹${sale.total.toFixed(2)}</td><td class="p-3"><button class="reprint-btn text-blue-500 hover:text-blue-700" data-id="${sale.id}"><i class="fas fa-print"></i></button></td></tr>`; DOMElements.historyTableBody.insertAdjacentHTML('beforeend', row); }); }
    function showHistoryDetail(saleId) { const sale = salesHistoryCache.find(s => s.id === saleId); if (!sale) return; DOMElements.historyDetailCustomer.textContent = `Customer: ${sale.customer_name || 'N/A'}`; DOMElements.historyDetailDate.textContent = `Billed on: ${new Date(sale.created_at).toLocaleString()}`; DOMElements.historyDetailItems.innerHTML = sale.items.map(item => `<tr class="border-b"><td class="p-2">${item.name}</td><td class="p-2">₹${item.price.toFixed(2)}</td><td class="p-2">${item.quantity}</td><td class="p-2 text-right">₹${(item.price * item.quantity).toFixed(2)}</td></tr>`).join(''); DOMElements.historyDetailModal.classList.remove('hidden'); }
    function handleReprint(saleId) { const sale = salesHistoryCache.find(s => s.id === saleId); if (!sale) return; DOMElements.receiptDate.textContent = new Date(sale.created_at).toLocaleString(); DOMElements.receiptCustomer.textContent = sale.customer_name ? `Customer: ${sale.customer_name}` : ''; DOMElements.receiptItems.innerHTML = sale.items.map(item => `<div class="grid grid-cols-12 gap-1"><div class="col-span-5">${item.name}</div><div class="col-span-2 text-right">${item.quantity}</div><div class="col-span-2 text-right">@${item.price.toFixed(2)}</div><div class="col-span-3 text-right">₹${(item.price * item.quantity).toFixed(2)}</div></div>`).join(''); DOMElements.receiptSubtotal.textContent = `₹${sale.subtotal.toFixed(2)}`; DOMElements.receiptDiscount.textContent = `-₹${sale.discount.toFixed(2)}`; DOMElements.receiptTotal.textContent = `₹${sale.total.toFixed(2)}`; window.print(); }
    let geminiApiKey = localStorage.getItem('geminiApiKey'); function getGeminiApiKey() { if (!geminiApiKey) { geminiApiKey = prompt("Please enter your Google Gemini API Key."); if (geminiApiKey) { localStorage.setItem('geminiApiKey', geminiApiKey); } } return geminiApiKey; } async function callGemini(prompt) { const apiKey = getGeminiApiKey(); if (!apiKey) { alert('Gemini API Key is required.'); return null; } const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`; try { const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); if (!response.ok) { throw new Error(`API call failed: ${response.statusText}`); } const data = await response.json(); return data.candidates[0].content.parts[0].text; } catch (error) { console.error('Gemini API Error:', error); alert('Failed to get AI response.'); return null; } } async function getAiSalesSummary() { if (salesHistoryCache.length < 1) { alert('Not enough sales data for a summary.'); return; } const salesDataString = salesHistoryCache.slice(0, 20).map(s => `Date: ${new Date(s.created_at).toLocaleDateString()}, Total: ${s.total}, Items: ${s.items.map(i => `${i.name} (Qty: ${i.quantity})`).join(', ')}`).join('\n'); const prompt = `You are a business analyst for a small retail store. Analyze the following recent sales data and provide a short, insightful summary (3-4 bullet points) of business performance and trends. Be concise and actionable.\n\nSales Data:\n${salesDataString}`; DOMElements.aiModalTitle.textContent = 'AI Sales Summary'; DOMElements.aiModalContent.innerHTML = '<p>Generating summary...</p>'; DOMElements.aiModal.classList.remove('hidden'); const summary = await callGemini(prompt); DOMElements.aiModalContent.innerHTML = summary ? summary.replace(/\n/g, '<br>') : '<p>Could not generate summary.</p>'; } async function getRecipeIdea() { if (currentBill.length === 0) { alert('Add items to the bill first!'); return; } const ingredients = currentBill.map(item => item.name).join(', '); const prompt = `Generate a simple and easy-to-follow recipe idea using some of these ingredients: ${ingredients}. The store is a general store, so assume basic pantry staples are available. The recipe should be short and clear.`; DOMElements.aiModalTitle.textContent = 'AI Recipe Idea'; DOMElements.aiModalContent.innerHTML = '<p>Thinking of a recipe...</p>'; DOMElements.aiModal.classList.remove('hidden'); const recipe = await callGemini(prompt); DOMElements.aiModalContent.innerHTML = recipe ? recipe.replace(/\n/g, '<br>') : '<p>Could not generate a recipe.</p>'; }

    DOMElements.signinBtn.addEventListener('click', handleSignIn); DOMElements.signupBtn.addEventListener('click', handleSignUp); DOMElements.googleSigninBtn.addEventListener('click', handleGoogleSignIn); DOMElements.logoutBtn.addEventListener('click', handleSignOut); DOMElements.navLinks.forEach(link => link.addEventListener('click', () => switchView(link.dataset.view))); DOMElements.lowStockCard.addEventListener('click', () => switchView('inventory', { lowStockOnly: true })); DOMElements.inventoryHeader.addEventListener('click', (e) => { if (e.target.id === 'show-all-btn') { renderInventoryTable(); } });
    DOMElements.addProductBtn.addEventListener('click', showAddProductModal); DOMElements.cancelAddProductModalBtn.addEventListener('click', hideAddProductModal); DOMElements.addProductForm.addEventListener('submit', handleAddProductSubmit);
    DOMElements.receiveStockBtn.addEventListener('click', showReceiveStockModal); DOMElements.cancelReceiveStockModal.addEventListener('click', hideReceiveStockModal);
    DOMElements.productSearchInput.addEventListener('keyup', handleProductSearch);
    DOMElements.receiveStockForm.addEventListener('submit', handleReceiveStockSubmit);
    DOMElements.inventoryTableBody.addEventListener('click', (e) => { const deleteBtn = e.target.closest('.delete-product-btn'); if (deleteBtn) { handleDeleteProduct(deleteBtn.dataset.id, deleteBtn.dataset.name); } });
    DOMElements.barcodeSearchInput.addEventListener('keyup', handleBarcodeSearch);
    DOMElements.searchResults.addEventListener('click', (e) => { const itemEl = e.target.closest('.search-result-item'); if (itemEl) { const product = inventoryCache.find(p => p.id === itemEl.dataset.id); if (product) addProductToBill(product); } }); document.addEventListener('click', (event) => { if (DOMElements.barcodeSearchInput && !DOMElements.barcodeSearchInput.contains(event.target)) { DOMElements.searchResults.classList.add('hidden'); } if (DOMElements.productSearchInput && !DOMElements.productSearchInput.contains(event.target) && !DOMElements.productSearchResults.contains(event.target)) { DOMElements.productSearchResults.classList.add('hidden'); } });
    DOMElements.billItemsBody.addEventListener('click', (e) => { const row = e.target.closest('tr'); if (!row || !row.dataset.batchId) return; const batchId = row.dataset.batchId; if (e.target.closest('.increment-qty-btn')) { handleBillQuantityChange(batchId, 1); } if (e.target.closest('.decrement-qty-btn')) { handleBillQuantityChange(batchId, -1); } if (e.target.closest('.remove-item-btn')) { handleRemoveItem(batchId); } });
    DOMElements.cancelSaleBtn.addEventListener('click', cancelSale); DOMElements.completeSaleBtn.addEventListener('click', showReceiptPreview);
    DOMElements.cancelReceiptBtn.addEventListener('click', () => DOMElements.receiptModal.classList.add('hidden'));
    DOMElements.confirmPrintBtn.addEventListener('click', handleConfirmAndPrint);
    DOMElements.historySearchInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') { DOMElements.filterByDateBtn.click(); }});
    DOMElements.filterByDateBtn.addEventListener('click', () => { const filters = { startDate: DOMElements.startDateInput.value, endDate: DOMElements.endDateInput.value, customerName: DOMElements.historySearchInput.value.trim() }; loadSalesHistory(filters); });
    DOMElements.clearFilterBtn.addEventListener('click', () => { DOMElements.startDateInput.value = ''; DOMElements.endDateInput.value = ''; DOMElements.historySearchInput.value = ''; loadSalesHistory(); });
    DOMElements.historyTableBody.addEventListener('click', e => { const reprintBtn = e.target.closest('.reprint-btn'); if (reprintBtn) { e.stopPropagation(); handleReprint(reprintBtn.dataset.id); return; } const row = e.target.closest('.history-row'); if (row) { showHistoryDetail(row.dataset.id); } });
    DOMElements.closeHistoryDetailModalBtn.addEventListener('click', () => DOMElements.historyDetailModal.classList.add('hidden'));
    DOMElements.aiSummaryBtn.addEventListener('click', getAiSalesSummary);
    DOMElements.recipeAiBtn.addEventListener('click', getRecipeIdea);
    DOMElements.closeAiModalBtn.addEventListener('click', () => DOMElements.aiModal.classList.add('hidden'));
</script>

</body>
</html>
