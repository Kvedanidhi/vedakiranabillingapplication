 <!DOCTYPE html>
<html lang="en">
<head>
Â <meta charset="UTF-8">
Â <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â <title>Veda Kirana - POS (Batch System)</title>
Â <script src="https://cdn.tailwindcss.com"></script>
Â <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
Â <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
Â <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
Â <style>
Â .view { display: none; }
Â .active-view { display: block; }
Â .nav-link.active { background-color: #374151; color: white; }
Â .modal-container { transition: opacity 0.2s ease-in-out; }
Â .modal-container.modal-hidden { opacity: 0; pointer-events: none; }
Â .modal-box { transition: transform 0.2s ease-in-out; }
Â .modal-container.modal-hidden .modal-box { transform: scale(0.95) translateY(1rem); }
Â /* Add styles for disabled buttons */
Â button:disabled { opacity: 0.6; cursor: not-allowed; }
Â @media print {
Â body * { visibility: hidden; }
Â #receipt-print-area, #receipt-print-area * { visibility: visible; }
Â #receipt-print-area { position: absolute; left: 0; top: 0; width: 100%; font-family: 'Courier New', Courier, monospace; font-size: 10px; }
Â @page { size: 80mm auto; margin: 2mm; }
Â }
Â #reader { width: 100%; border: 2px solid #e5e7eb; border-radius: 0.5rem; }
Â </style>
</head>
<body class="bg-slate-100">


Â <div id="auth-screen" class="min-h-screen flex items-center justify-center bg-slate-900 p-4"><div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md"><div class="text-center mb-6"><h1 class="text-3xl font-bold text-slate-800">VEDA KIRANA POS</h1><p class="text-slate-500">Welcome! Please sign in to continue.</p></div><form id="auth-form" class="space-y-4"><input type="email" id="email" placeholder="Email" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><input type="password" id="password" placeholder="Password" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><div id="auth-error" class="text-red-500 text-sm hidden"></div><div class="flex space-x-4"><button type="button" id="signin-btn" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-all duration-200 transform hover:scale-105 active:scale-95">Sign In</button><button type="button" id="signup-btn" class="w-full bg-slate-700 text-white py-3 rounded-lg hover:bg-slate-800 transition-all duration-200 transform hover:scale-105 active:scale-95">Sign Up</button></div></form><div class="text-center my-4 relative"><hr class="border-slate-200"><span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-2 text-slate-400 text-sm">OR</span></div><button id="google-signin-btn" class="w-full flex items-center justify-center bg-white border border-slate-300 text-slate-700 py-3 rounded-lg hover:bg-slate-50 transition-colors"><img src="https://www.google.com/favicon.ico" class="w-5 h-5 mr-2" alt="Google icon"> Continue with Google</button></div></div>
Â <div id="app-screen" class="hidden">
Â <div class="flex h-screen bg-slate-100">
Â <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col"><div class="p-4 border-b border-slate-800 text-center"><h1 class="text-2xl font-bold text-white">Veda Kirana</h1></div><nav class="flex-1 p-2 space-y-2"><a data-view="dashboard" class="nav-link active flex items-center p-3 rounded-lg transition-colors duration-200 hover:bg-slate-800 hover:text-white"><i class="fas fa-chart-pie mr-3 w-5 text-slate-400"></i> Dashboard</a><a data-view="billing" class="nav-link flex items-center p-3 rounded-lg transition-colors duration-200 hover:bg-slate-800 hover:text-white"><i class="fas fa-cash-register mr-3 w-5 text-slate-400"></i> Billing</a><a data-view="inventory" class="nav-link flex items-center p-3 rounded-lg transition-colors duration-200 hover:bg-slate-800 hover:text-white"><i class="fas fa-boxes-stacked mr-3 w-5 text-slate-400"></i> Inventory</a><a data-view="history" class="nav-link flex items-center p-3 rounded-lg transition-colors duration-200 hover:bg-slate-800 hover:text-white"><i class="fas fa-history mr-3 w-5 text-slate-400"></i> Past History</a><a data-view="reports" class="nav-link flex items-center p-3 rounded-lg transition-colors duration-200 hover:bg-slate-800 hover:text-white"><i class="fas fa-chart-line mr-3 w-5 text-slate-400"></i> Reports</a></nav><div class="p-4 border-t border-slate-800 space-y-2"><button id="connect-printer-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg transition-transform hover:scale-105 active:scale-95 flex items-center justify-center"><i class="fas fa-print mr-2"></i> Connect Printer</button><button class="logout-button w-full bg-red-600 text-white py-2 rounded-lg transition-transform hover:scale-105 active:scale-95 flex items-center justify-center"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button></div></aside>
Â <main class="flex-1 p-6 overflow-y-auto">
Â <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex justify-between items-center"><h2 id="welcome-message" class="text-xl font-semibold text-slate-700">Welcome back!</h2><button class="logout-button text-sm bg-slate-200 text-slate-700 px-3 py-1 rounded-md hover:bg-red-500 hover:text-white transition-colors duration-200"><i class="fas fa-sign-out-alt mr-1"></i> Logout</button></div>
Â <section id="dashboard-view" class="view active-view"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6"><div class="p-6 rounded-xl shadow-lg bg-gradient-to-br from-blue-500 to-indigo-600 text-white transition-transform hover:-translate-y-1"><h3 class="text-lg font-medium">Today's Sales</h3><p id="total-sales" class="text-4xl font-bold">â‚¹0.00</p></div><div class="p-6 rounded-xl shadow-lg bg-gradient-to-br from-indigo-500 to-purple-600 text-white transition-transform hover:-translate-y-1"><h3 class="text-lg font-medium">Today's Bills</h3><p id="total-transactions" class="text-4xl font-bold">0</p></div><div id="low-stock-card" class="p-6 rounded-xl shadow-lg bg-gradient-to-br from-yellow-400 to-orange-500 text-white transition-transform hover:-translate-y-1 cursor-pointer"><h3 class="text-lg font-medium">Low Stock Items</h3><p id="low-stock-items" class="text-4xl font-bold">0</p></div><div id="expiring-soon-card" class="p-6 rounded-xl shadow-lg bg-gradient-to-br from-red-500 to-orange-600 text-white transition-transform hover:-translate-y-1 cursor-pointer"><h3 class="text-lg font-medium">Expiring Soon (30d)</h3><p id="expiring-soon-items" class="text-4xl font-bold">0</p></div></div><div><button id="ai-summary-btn" class="bg-slate-800 text-white px-4 py-2 rounded-lg transition-transform hover:scale-105 active:scale-95 flex items-center"><i class="fas fa-robot mr-2"></i> Get AI Sales Summary</button></div></section>
Â <section id="billing-view" class="view"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm"><div class="flex items-center gap-2 mb-4"><div class="relative flex-grow"><i class="fas fa-barcode absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i><input type="text" id="barcode-search" placeholder="Scan with device or search..." class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div><button id="scan-with-camera-btn" class="flex-shrink-0 px-4 py-2 bg-indigo-600 text-white rounded-lg transition-transform hover:scale-105 active:scale-95"><i class="fas fa-camera"></i></button></div><div id="search-results" class="absolute z-10 w-full bg-white border rounded-lg shadow-lg hidden max-h-48 overflow-y-auto"></div><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-slate-50 border-b"><th class="p-3 font-semibold text-slate-600">Product</th><th class="p-3 font-semibold text-slate-600">Price</th><th class="p-3 font-semibold text-slate-600 text-center">Quantity</th><th class="p-3 font-semibold text-slate-600">Total</th><th class="p-3 font-semibold text-slate-600 text-center">Action</th></tr></thead><tbody id="bill-items-body" class="divide-y divide-slate-200"><tr id="bill-placeholder"><td colspan="5" class="text-center p-6 text-slate-500">Scan an item to begin...</td></tr></tbody></table></div></div><div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-2xl font-bold mb-4 border-b pb-2 text-slate-800">Bill Summary</h3><div class="space-y-3 mb-4 text-lg text-slate-700"><div class="flex justify-between"><span>Subtotal:</span> <span id="bill-subtotal" class="font-medium">â‚¹0.00</span></div><div class="flex justify-between"><span>Store Discount (2%):</span> <span id="bill-discount" class="font-medium text-red-500">-â‚¹0.00</span></div><div class="flex justify-between font-bold text-2xl border-t pt-3 text-slate-900"><span>Total:</span> <span id="bill-total">â‚¹0.00</span></div></div><div class="space-y-4 mb-4"><input type="text" id="customer-name" placeholder="Customer Name (Optional)" class="w-full px-4 py-2 border border-slate-300 rounded-lg"><input type="text" id="customer-phone" placeholder="Customer Phone (Optional)" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></div><div class="space-y-2"><button id="complete-sale-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold text-lg transition-transform hover:scale-105 active:scale-95" disabled>Complete Sale</button><button id="cancel-sale-btn" class="w-full bg-red-500 text-white py-2 rounded-lg transition-transform hover:scale-105 active:scale-95">Cancel Sale</button></div><div class="mt-4"><button id="recipe-ai-btn" class="w-full bg-purple-600 text-white py-2 rounded-lg transition-transform hover:scale-105 active:scale-95 flex items-center justify-center"><i class="fas fa-utensils mr-2"></i> Get Recipe Idea</button></div></div></div></section>
Â <section id="inventory-view" class="view"><div class="bg-white p-6 rounded-xl shadow-sm"><div class="flex justify-between items-center mb-4"><div id="inventory-header"><h2 class="text-2xl font-bold text-slate-800">Manage Inventory</h2></div><div class="space-x-2"><button id="add-product-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg transition-transform hover:scale-105 active:scale-95">Add New Product</button><button id="receive-stock-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg transition-transform hover:scale-105 active:scale-95">Receive Stock</button></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-slate-50 border-b"><th class="p-3 font-semibold text-slate-600">Name</th><th class="p-3 font-semibold text-slate-600">Barcode</th><th class="p-3 font-semibold text-slate-600">Category</th><th class="p-3 font-semibold text-slate-600">Total Stock</th><th class="p-3 font-semibold text-slate-600">Batches</th><th class="p-3 font-semibold text-slate-600">Expires Soonest</th><th class="p-3 font-semibold text-slate-600 text-center">Actions</th></tr></thead><tbody id="inventory-table-body" class="divide-y divide-slate-200"></tbody></table></div></div></section>
Â <section id="history-view" class="view"><div class="bg-white p-6 rounded-xl shadow-sm"><h2 class="text-2xl font-bold mb-4 text-slate-800">Sales History</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end bg-slate-50 p-4 rounded-lg mb-4"><div><label for="start-date" class="block text-sm font-medium text-slate-700">Start Date</label><input type="date" id="start-date" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></div><div><label for="end-date" class="block text-sm font-medium text-slate-700">End Date</label><input type="date" id="end-date" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></div><div><label for="history-search" class="block text-sm font-medium text-slate-700">Customer Name</label><input type="text" id="history-search" placeholder="Search by name..." class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></div><div class="flex space-x-2"><button id="filter-by-date-btn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg transition-transform hover:scale-105 active:scale-95">Filter</button><button id="clear-filter-btn" class="w-full bg-slate-300 text-slate-800 px-4 py-2 rounded-lg hover:bg-slate-400">Clear</button></div></div><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-slate-50 border-b"><th class="p-3 font-semibold text-slate-600">Date</th><th class="p-3 font-semibold text-slate-600">Customer</th><th class="p-3 font-semibold text-slate-600">Total</th><th class="p-3 font-semibold text-slate-600">Actions</th></tr></thead><tbody id="history-table-body" class="divide-y divide-slate-200"></tbody></table></div></div></section>
Â <section id="reports-view" class="view"><div class="bg-white p-6 rounded-xl shadow-sm mb-6"><h2 class="text-2xl font-bold mb-4 text-slate-800">Inventory Reports (Last 90 Days)</h2></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-xl font-semibold mb-4 text-green-600">ğŸš€ Fast-Moving Items (Top Sellers)</h3><table class="w-full text-left text-sm"><thead><tr class="bg-slate-50 border-b"><th class="p-2 font-semibold text-slate-600">Product</th><th class="p-2 font-semibold text-slate-600 text-right">Units Sold</th><th class="p-2 font-semibold text-slate-600 text-right">Current Stock</th></tr></thead><tbody id="fast-moving-table" class="divide-y divide-slate-200"></tbody></table></div><div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-xl font-semibold mb-4 text-red-600">ğŸŒ Slow-Moving Items (Bottom Sellers)</h3><table class="w-full text-left text-sm"><thead><tr class="bg-slate-50 border-b"><th class="p-2 font-semibold text-slate-600">Product</th><th class="p-2 font-semibold text-slate-600 text-right">Units Sold</th><th class="p-2 font-semibold text-slate-600 text-right">Current Stock</th></tr></thead><tbody id="slow-moving-table" class="divide-y divide-slate-200"></tbody></table></div></div></section>
Â </main>
Â </div>
Â </div>
Â <div id="add-product-modal" class="modal-container modal-hidden fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="modal-box bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg"><h2 class="text-2xl font-bold mb-6 text-slate-800">Add a New Product</h2><form id="add-product-form" class="space-y-4"><p class="text-sm text-slate-600">This creates a product with zero stock. Use "Receive Stock" to add inventory.</p><input type="text" id="new-product-name" placeholder="Product Name (e.g., Sugar, Rice)" required class="w-full p-2 border border-slate-300 rounded-lg"><div class="flex items-center gap-2"><input type="text" id="new-product-barcode" placeholder="Barcode (Optional, must be unique)" class="w-full p-2 border border-slate-300 rounded-lg"><button type="button" id="add-product-scan-btn" class="flex-shrink-0 px-4 py-2 bg-indigo-600 text-white rounded-lg transition-transform hover:scale-105 active:scale-95"><i class="fas fa-camera"></i></button></div><div><label class="block font-medium text-slate-700">Category</label><select id="new-product-category" class="w-full p-2 border border-slate-300 rounded-lg mt-1"><option value="General">General</option><option value="Kirana">Kirana</option></select></div><div id="new-product-weight-container" class="hidden"><label for="new-product-weight" class="block font-medium text-slate-700">Weight</label><select id="new-product-weight" class="w-full p-2 border border-slate-300 rounded-lg mt-1"><option value="">Select Weight</option><option value="250g">250g</option><option value="500g">500g</option><option value="750g">750g</option><option value="1kg">1kg</option><option value="1.5kg">1.5kg</option><option value="2kg">2kg</option><option value="5kg">5kg</option><option value="10kg">10kg</option></select></div><div class="flex justify-end gap-4 pt-4"><button type="button" id="cancel-add-product-modal" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg hover:bg-slate-300">Cancel</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg transition-transform hover:scale-105 active:scale-95">Create Product</button></div></form></div></div>
Â <div id="receive-stock-modal" class="modal-container modal-hidden fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="modal-box bg-white p-8 rounded-xl shadow-2xl w-full max-w-xl"><h2 class="text-2xl font-bold mb-6 text-slate-800">Receive New Stock Batch</h2><form id="receive-stock-form" class="space-y-4"><div class="relative"><label class="block font-medium text-slate-700">Search for an Existing Product</label><div class="flex items-center gap-2 mt-1"><input type="text" id="product-search-input" placeholder="Search by name or barcode..." class="w-full p-2 border border-slate-300 rounded-lg"><button type="button" id="inventory-scan-btn" class="flex-shrink-0 px-4 py-2 bg-indigo-600 text-white rounded-lg transition-transform hover:scale-105 active:scale-95"><i class="fas fa-camera"></i></button></div><div id="product-search-results" class="absolute z-10 w-full bg-white border rounded-lg shadow-lg hidden max-h-48 overflow-y-auto"></div></div><div id="batch-details-fields" class="hidden pt-4 border-t space-y-3"><h3 class="text-lg font-semibold text-slate-800">Adding Batch to: <span id="selected-product-name" class="text-indigo-600"></span></h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block font-medium text-slate-700">Quantity Received</label><input type="number" id="batch-quantity" placeholder="e.g., 50" required class="w-full p-2 border border-slate-300 rounded-lg"></div><div><label class="block font-medium text-slate-700">Purchase Price (Cost)</label><input type="number" step="0.01" id="batch-purchase-price" placeholder="e.g., 150.00" required class="w-full p-2 border border-slate-300 rounded-lg"></div><div><label class="block font-medium text-slate-700">Selling Price</label><input type="number" step="0.01" id="batch-selling-price" placeholder="e.g., 180.00" required class="w-full p-2 border border-slate-300 rounded-lg"></div><div><label class="block font-medium text-slate-700">Expiry Date (Optional)</label><input type="date" id="batch-expiry-date" class="w-full p-2 border border-slate-300 rounded-lg"></div></div></div><div class="flex justify-end gap-4 pt-4"><button type="button" id="cancel-receive-stock-modal" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg hover:bg-slate-300">Cancel</button><button type="submit" id="confirm-batch-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg transition-transform hover:scale-105 active:scale-95" disabled>Save Batch</button></div></form></div></div>
Â <div id="camera-scanner-modal" class="modal-container modal-hidden fixed inset-0 bg-slate-900 bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50 p-4"><div class="modal-box bg-white p-4 rounded-xl shadow-2xl w-full max-w-md mx-4"><h2 class="text-xl font-bold mb-4 text-slate-800">Scan Barcode</h2><div id="reader" class="mb-4"></div><button id="cancel-scan-btn" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-transform hover:scale-105 active:scale-95">Cancel</button></div></div>
Â <div id="receipt-modal" class="modal-container modal-hidden fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="modal-box bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm"><div id="receipt-print-area" class="text-black text-xs"><div class="text-center mb-4"><h2 class="text-lg font-bold">VEDA KIRANA AND GENERAL STORE</h2><p>Ratna Complex, 509338</p><p>Phone: 8309913409</p><p id="receipt-date" class="mt-2 text-xs"></p><p id="receipt-customer" class="text-xs"></p></div><div class="border-t border-b border-dashed border-black my-2 py-2"><div class="grid grid-cols-12 gap-1 font-bold"><div class="col-span-5">Item</div><div class="col-span-2 text-right">Qty</div><div class="col-span-2 text-right">Price</div><div class="col-span-3 text-right">Total</div></div><div id="receipt-items" class="mt-1 space-y-1"></div></div><div class="space-y-1 mt-2 text-right"><p>Subtotal: <span id="receipt-subtotal"></span></p><p>Discount: <span id="receipt-discount"></span></p><p class="font-bold text-sm">TOTAL: <span id="receipt-total"></span></p></div><p class="text-center mt-4">Thank you for your visit!</p></div><div class="flex justify-end gap-4 mt-6"><button type="button" id="cancel-receipt-btn" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg hover:bg-slate-300">Cancel</button><button type="button" id="direct-print-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg transition-transform hover:scale-105 active:scale-95"><i class="fas fa-print mr-2"></i> Direct Bluetooth Print</button></div></div></div>
Â <div id="ai-modal" class="modal-container modal-hidden fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="modal-box bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl"><h2 id="ai-modal-title" class="text-2xl font-bold mb-4 text-slate-800">AI Analysis</h2><div id="ai-modal-content" class="bg-slate-100 p-4 rounded-lg max-h-96 overflow-y-auto prose"></div><div class="flex justify-end mt-6"><button id="close-ai-modal" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Close</button></div></div></div>
Â <div id="history-detail-modal" class="modal-container modal-hidden fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50 p-4"><div class="modal-box bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg"><h2 class="text-2xl font-bold mb-2 text-slate-800">Transaction Details</h2><div class="flex justify-between text-slate-600 mb-4 border-b pb-2"><p id="history-detail-customer"></p><p id="history-detail-date"></p></div><div class="max-h-80 overflow-y-auto"><table class="w-full text-left"><thead><tr class="bg-slate-50"><th class="p-2 font-semibold text-slate-600">Item</th><th class="p-2 font-semibold text-slate-600 text-center">Qty</th><th class="p-2 font-semibold text-slate-600">Price</th><th class="p-2 font-semibold text-green-600">Profit</th><th class="p-2 font-semibold text-slate-600 text-right">Total</th></tr></thead><tbody id="history-detail-items" class="divide-y divide-slate-200"></tbody></table></div><div class="flex justify-end mt-4 pt-4 border-t font-bold"><span class="text-lg text-slate-800">Total Profit For This Bill:</span><span id="history-detail-total-profit" class="text-lg ml-4 text-green-700"></span></div><div class="flex justify-end mt-6"><button id="close-history-detail-modal" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Close</button></div></div></div>


<script type="module">
Â // ==================================================================
Â // === DANGER: PASTE YOUR SUPABASE KEYS HERE ===
Â // ==================================================================
Â // DO NOT SHARE THIS FILE PUBLICLY WITH YOUR KEYS IN IT
Â const SUPABASE_URL = "https://rthuzwhtwuhbzdokwgme.supabase.co";
Â const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0aHV6d2h0d3VoYnpkb2t3Z21lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDQyODYsImV4cCI6MjA3MzgyMDI4Nn0.zs17CD9KBZmuVjhQDs0EP1ut9fy-TkalWy5DE63SHgk";
Â // ==================================================================


Â const { createClient } = supabase;
Â const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
Â let currentUser = null, inventoryCache = [], currentBill = [], salesHistoryCache = [], selectedProductForBatch = null, cameraScanner = null;
Â let printerDevice = null, printerCharacteristic = null;


Â const DOMElements = {
Â authScreen: document.getElementById('auth-screen'), appScreen: document.getElementById('app-screen'), authForm: document.getElementById('auth-form'),
Â emailInput: document.getElementById('email'), passwordInput: document.getElementById('password'), authError: document.getElementById('auth-error'),
Â signinBtn: document.getElementById('signin-btn'), signupBtn: document.getElementById('signup-btn'), googleSigninBtn: document.getElementById('google-signin-btn'),
Â logoutBtns: document.querySelectorAll('.logout-button'), welcomeMessage: document.getElementById('welcome-message'), navLinks: document.querySelectorAll('.nav-link'),
Â views: document.querySelectorAll('.view'), totalSales: document.getElementById('total-sales'), totalTransactions: document.getElementById('total-transactions'),
Â lowStockItems: document.getElementById('low-stock-items'), lowStockCard: document.getElementById('low-stock-card'),
Â expiringSoonCard: document.getElementById('expiring-soon-card'), expiringSoonItems: document.getElementById('expiring-soon-items'),
Â aiSummaryBtn: document.getElementById('ai-summary-btn'),
Â inventoryTableBody: document.getElementById('inventory-table-body'), inventoryHeader: document.getElementById('inventory-header'),
Â addProductBtn: document.getElementById('add-product-btn'),
Â receiveStockBtn: document.getElementById('receive-stock-btn'),
Â addProductModal: document.getElementById('add-product-modal'), addProductForm: document.getElementById('add-product-form'),
Â newProductName: document.getElementById('new-product-name'), newProductBarcode: document.getElementById('new-product-barcode'),
Â newProductCategory: document.getElementById('new-product-category'), cancelAddProductModalBtn: document.getElementById('cancel-add-product-modal'),
Â addProductScanBtn: document.getElementById('add-product-scan-btn'),
Â newProductWeightContainer: document.getElementById('new-product-weight-container'),
Â newProductWeight: document.getElementById('new-product-weight'),
Â receiveStockModal: document.getElementById('receive-stock-modal'), receiveStockForm: document.getElementById('receive-stock-form'),
Â productSearchInput: document.getElementById('product-search-input'), productSearchResults: document.getElementById('product-search-results'),
Â batchDetailsFields: document.getElementById('batch-details-fields'), selectedProductName: document.getElementById('selected-product-name'),
Â batchQuantity: document.getElementById('batch-quantity'), batchPurchasePrice: document.getElementById('batch-purchase-price'),
Â batchSellingPrice: document.getElementById('batch-selling-price'), batchExpiryDate: document.getElementById('batch-expiry-date'),
Â cancelReceiveStockModal: document.getElementById('cancel-receive-stock-modal'),
Â confirmBatchBtn: document.getElementById('confirm-batch-btn'),
Â barcodeSearchInput: document.getElementById('barcode-search'), searchResults: document.getElementById('search-results'),
Â billItemsBody: document.getElementById('bill-items-body'), billPlaceholder: document.getElementById('bill-placeholder'), billSubtotal: document.getElementById('bill-subtotal'),
Â billDiscount: document.getElementById('bill-discount'), billTotal: document.getElementById('bill-total'), customerNameInput: document.getElementById('customer-name'),
Â customerPhoneInput: document.getElementById('customer-phone'), completeSaleBtn: document.getElementById('complete-sale-btn'), cancelSaleBtn: document.getElementById('cancel-sale-btn'),
Â recipeAiBtn: document.getElementById('recipe-ai-btn'), receiptModal: document.getElementById('receipt-modal'), receiptDate: document.getElementById('receipt-date'),
Â receiptCustomer: document.getElementById('receipt-customer'), receiptItems: document.getElementById('receipt-items'), receiptSubtotal: document.getElementById('receipt-subtotal'),
Â receiptDiscount: document.getElementById('receipt-discount'), receiptTotal: document.getElementById('receipt-total'), cancelReceiptBtn: document.getElementById('cancel-receipt-btn'),
Â directPrintBtn: document.getElementById('direct-print-btn'),
Â historyTableBody: document.getElementById('history-table-body'), historySearchInput: document.getElementById('history-search'),
Â historyDetailModal: document.getElementById('history-detail-modal'), historyDetailCustomer: document.getElementById('history-detail-customer'),
Â historyDetailDate: document.getElementById('history-detail-date'), historyDetailItems: document.getElementById('history-detail-items'),
Â historyDetailTotalProfit: document.getElementById('history-detail-total-profit'),
Â closeHistoryDetailModalBtn: document.getElementById('close-history-detail-modal'),
Â aiModal: document.getElementById('ai-modal'), aiModalTitle: document.getElementById('ai-modal-title'), aiModalContent: document.getElementById('ai-modal-content'),
Â closeAiModalBtn: document.getElementById('close-ai-modal'),
Â startDateInput: document.getElementById('start-date'), endDateInput: document.getElementById('end-date'),
Â filterByDateBtn: document.getElementById('filter-by-date-btn'), clearFilterBtn: document.getElementById('clear-filter-btn'),
Â scanWithCameraBtn: document.getElementById('scan-with-camera-btn'),
Â cameraScannerModal: document.getElementById('camera-scanner-modal'),
Â cameraReaderDiv: document.getElementById('reader'),
Â cancelScanBtn: document.getElementById('cancel-scan-btn'),
Â inventoryScanBtn: document.getElementById('inventory-scan-btn'),
Â fastMovingTable: document.getElementById('fast-moving-table'), slowMovingTable: document.getElementById('slow-moving-table'),
Â connectPrinterBtn: document.getElementById('connect-printer-btn'),
Â // addProductSubmitBtn is defined below
Â }; // <= Closing brace of DOMElements object


Â // === FIX FOR ReferenceError ===
Â // Define addProductSubmitBtn AFTER DOMElements is created
Â DOMElements.addProductSubmitBtn = DOMElements.addProductForm.querySelector('button[type="submit"]');Â 
Â 
Â const allModals = document.querySelectorAll('.modal-container');
Â function showModal(modalElement) { modalElement.classList.remove('modal-hidden'); }
Â function hideModal(modalElement) { modalElement.classList.add('modal-hidden'); }
Â allModals.forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal) { hideModal(modal); } }); });


Â document.addEventListener('DOMContentLoaded', checkUser);
Â async function checkUser() { const { data: { session } } = await db.auth.getSession(); if (session) { currentUser = session.user; showAppScreen(); } else { showAuthScreen(); } }
Â db.auth.onAuthStateChange((event, session) => { if (event === 'SIGNED_IN') { currentUser = session.user; showAppScreen(); } else if (event === 'SIGNED_OUT') { currentUser = null; showAuthScreen(); } });
Â 
Â async function handleSignIn() {
Â DOMElements.signinBtn.disabled = true;
Â DOMElements.signinBtn.textContent = 'Signing In...';
Â 
Â const { data, error } = await db.auth.signInWithPassword({Â 
Â email: DOMElements.emailInput.value,Â 
Â password: DOMElements.passwordInput.valueÂ 
Â });Â 
Â 
Â if (error) {
Â DOMElements.authError.textContent = error.message;Â 
Â DOMElements.authError.classList.remove('hidden');
Â DOMElements.signinBtn.disabled = false;
Â DOMElements.signinBtn.textContent = 'Sign In';
Â } else if (data.user) {Â 
Â DOMElements.authError.classList.add('hidden');Â 
Â currentUser = data.user;Â 
Â showAppScreen();
Â DOMElements.signinBtn.textContent = 'Sign In';Â 
Â DOMElements.signinBtn.disabled = false;
Â } else {Â 
Â DOMElements.authError.textContent = 'Sign in failed. Please try again.';
Â DOMElements.authError.classList.remove('hidden');
Â DOMElements.signinBtn.disabled = false;
Â DOMElements.signinBtn.textContent = 'Sign In';
Â }
Â }


Â async function handleSignUp() {
Â DOMElements.signupBtn.disabled = true;
Â DOMElements.signupBtn.textContent = 'Signing Up...';
Â DOMElements.authError.classList.add('hidden');


Â const { error } = await db.auth.signUp({Â 
Â email: DOMElements.emailInput.value,Â 
Â password: DOMElements.passwordInput.valueÂ 
Â });Â 


Â if (error) {Â 
Â DOMElements.authError.textContent = error.message;Â 
Â DOMElements.authError.classList.remove('hidden');Â 
Â } else {Â 
Â alert('Sign up successful! Please check your email to confirm.');Â 
Â DOMElements.emailInput.value = '';Â 
Â DOMElements.passwordInput.value = '';
Â }


Â DOMElements.signupBtn.disabled = false;
Â DOMElements.signupBtn.textContent = 'Sign Up';
Â }


Â async function handleGoogleSignIn() {Â 
Â DOMElements.googleSigninBtn.disabled = true;
Â DOMElements.googleSigninBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 text-slate-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...';
Â try {
Â await db.auth.signInWithOAuth({ provider: 'google' });Â 
Â } catch (error) {
Â console.error("Google Sign In Error:", error);
Â alert("Google Sign In failed. Please try again.");
Â DOMElements.googleSigninBtn.disabled = false;
Â DOMElements.googleSigninBtn.innerHTML = '<img src="https://www.google.com/favicon.ico" class="w-5 h-5 mr-2" alt="Google icon"> Continue with Google';
Â }
Â }
Â async function handleSignOut() { await db.auth.signOut(); }
Â function showAppScreen() { DOMElements.authScreen.classList.add('hidden'); DOMElements.appScreen.classList.remove('hidden'); const displayName = currentUser.email.split('@')[0]; DOMElements.welcomeMessage.textContent = `Welcome back, ${displayName}!`; loadInventory(); loadSalesHistory(); }
Â function showAuthScreen() { DOMElements.authScreen.classList.remove('hidden'); DOMElements.appScreen.classList.add('hidden'); }


Â function switchView(viewId, params = {}) { DOMElements.views.forEach(view => view.classList.remove('active-view')); document.getElementById(`${viewId}-view`).classList.add('active-view'); DOMElements.navLinks.forEach(link => { link.classList.remove('active', 'bg-slate-700', 'text-white'); if(link.dataset.view === viewId) link.classList.add('active', 'bg-slate-700', 'text-white'); }); if (viewId === 'billing') { setTimeout(() => DOMElements.barcodeSearchInput.focus(), 0); } if (viewId === 'inventory') { renderInventoryTable(params); } if (viewId === 'history') { loadSalesHistory(); } if (viewId === 'reports') { loadReportsData(); } }
Â async function loadDashboardData() { const today = new Date(); today.setHours(0, 0, 0, 0); const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1); const { data: sales, error: salesError } = await db.from('sales').select('total').gte('created_at', today.toISOString()).lt('created_at', tomorrow.toISOString()); if (salesError) { console.error('Error fetching dashboard sales:', salesError); return; } const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0); DOMElements.totalSales.textContent = `â‚¹${totalSales.toFixed(2)}`; DOMElements.totalTransactions.textContent = sales.length; const lowStockCount = inventoryCache.filter(p => p.totalStock > 0 && p.totalStock < 10).length; DOMElements.lowStockItems.textContent = lowStockCount; const thirtyDaysFromNow = new Date(); thirtyDaysFromNow.setDate(today.getDate() + 30); let expiringSoonCount = 0; inventoryCache.forEach(p => { const isExpiring = p.batches.some(b => b.expiry_date && new Date(b.expiry_date) >= today && new Date(b.expiry_date) <= thirtyDaysFromNow); if (isExpiring) { expiringSoonCount++; } }); DOMElements.expiringSoonItems.textContent = expiringSoonCount; }
Â 
Â // ==================================================================
Â // === loadInventory with NESTED SORTING REMOVED ===
Â // ==================================================================
Â async function loadInventory() {
Â const { data, error } = await db.from('products')
Â .select(`*, stock_batches(*)`)
Â .order('created_at', { ascending: true }); // Only order parent products


Â if (error) {Â 
Â console.error('Error loading inventory:', error);Â 
Â DOMElements.inventoryTableBody.innerHTML = `<tr><td colspan="7" class="text-center p-6 text-red-500">Error loading inventory. Please refresh. Details: ${error.message}</td></tr>`;
Â return;Â 
Â }
Â 
Â inventoryCache = data.map(product => {
Â const batches = Array.isArray(product.stock_batches) ? product.stock_batches : [];
Â // Filter AND sort batches here in JavaScript
Â const activeBatches = batches.filter(b => b.quantity_remaining > 0)
Â .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));Â 
Â const totalStock = activeBatches.reduce((sum, b) => sum + b.quantity_remaining, 0);
Â return { ...product, batches: activeBatches, totalStock };Â 
Â });
Â 
Â renderInventoryTable();
Â await loadDashboardData();Â 
Â }


Â function renderInventoryTable(filters = {}) { let itemsToRender = inventoryCache; const today = new Date(); today.setHours(0,0,0,0);Â 
Â const thirtyDaysFromNow = new Date(); thirtyDaysFromNow.setDate(today.getDate() + 30); if (filters.lowStockOnly) { itemsToRender = inventoryCache.filter(p => p.totalStock > 0 && p.totalStock < 10); DOMElements.inventoryHeader.innerHTML = `<div><h2 class="text-2xl font-bold text-yellow-600">Showing Low Stock Items</h2><button id="show-all-btn" class="text-sm text-blue-500 hover:underline mt-1">Show All Items</button></div>`; } else if (filters.expiringSoon) { itemsToRender = inventoryCache.filter(p => p.batches.some(b => b.expiry_date && new Date(b.expiry_date) >= today && new Date(b.expiry_date) <= thirtyDaysFromNow)); DOMElements.inventoryHeader.innerHTML = `<div><h2 class="text-2xl font-bold text-red-600">Showing Items Expiring Soon</h2><button id="show-all-btn" class="text-sm text-blue-500 hover:underline mt-1">Show All Items</button></div>`; } else { DOMElements.inventoryHeader.innerHTML = `<h2 class="text-2xl font-bold text-slate-800">Manage Inventory</h2>`; } DOMElements.inventoryTableBody.innerHTML = ''; if (itemsToRender.length === 0) { DOMElements.inventoryTableBody.innerHTML = `<tr><td colspan="7" class="text-center p-6 text-slate-500">No products found.</td></tr>`; return; } itemsToRender.forEach(product => { let soonestExpiry = null; product.batches.forEach(b => { if (b.expiry_date) { try { const batchExpiry = new Date(b.expiry_date); if (!isNaN(batchExpiry)) {Â 
Â if (!soonestExpiry || batchExpiry < soonestExpiry) { soonestExpiry = batchExpiry; } } } catch(e) { console.error("Invalid date format for batch:", b); } } }); const expiryText = soonestExpiry ? soonestExpiry.toLocaleDateString('en-IN') : 'N/A'; let expiryClass = ''; if (soonestExpiry && soonestExpiry < today) { expiryClass = 'text-red-700 font-bold'; } else if (soonestExpiry && soonestExpiry <= thirtyDaysFromNow) { expiryClass = 'text-yellow-600 font-semibold'; } const row = `<tr class="border-b hover:bg-slate-50"><td class="p-3 font-semibold">${product.name}</td><td class="p-3 font-mono">${product.barcode || 'N/A'}</td><td class="p-3">${product.category}</td><td class="p-3 text-lg font-bold ${product.totalStock < 10 && product.totalStock > 0 ? 'text-red-500' : ''}">${product.totalStock}</td><td class="p-3 text-xs">${product.batches.length}</td><td class="p-3 ${expiryClass}">${expiryText}</td><td class="p-3 text-center"><button class="delete-product-btn text-red-500 hover:text-red-700" data-id="${product.id}" data-name="${product.name}"><i class="fas fa-trash-alt"></i></button></td></tr>`; DOMElements.inventoryTableBody.insertAdjacentHTML('beforeend', row); }); }
Â async function handleDeleteProduct(productId, productName) { if (!confirm(`Are you sure you want to delete "${productName}"?\nThis action cannot be undone and will delete all associated stock batches.`)) { return; }Â 
Â const deleteButton = DOMElements.inventoryTableBody.querySelector(`.delete-product-btn[data-id="${productId}"]`);
Â if(deleteButton) deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';Â 


Â const { error } = await db.from('products').delete().eq('id', productId);Â 


Â if (error) {Â 
Â alert('Error deleting product: ' + error.message);Â 
Â if(deleteButton) deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';Â 
Â } else {Â 
Â inventoryCache = inventoryCache.filter(p => p.id !== productId);
Â renderInventoryTable();Â 
Â alert(`"${productName}" was deleted successfully.`);Â 
Â await loadDashboardData();Â 
Â }Â 
Â }
Â function showAddProductModal() { DOMElements.addProductForm.reset(); DOMElements.newProductWeightContainer.classList.add('hidden'); DOMElements.newProductCategory.value = 'General'; showModal(DOMElements.addProductModal); DOMElements.newProductName.focus(); }
Â function hideAddProductModal() { hideModal(DOMElements.addProductModal); }
Â 
Â async function handleAddProductSubmit(e) {Â 
Â e.preventDefault();Â 
Â const submitBtn = DOMElements.addProductSubmitBtn;
Â submitBtn.disabled = true;
Â submitBtn.textContent = 'Creating...';


Â let productName = DOMElements.newProductName.value.trim();Â 
Â const barcode = DOMElements.newProductBarcode.value.trim();Â 
Â const category = DOMElements.newProductCategory.value;Â 
Â if (category === 'Kirana') { const weight = DOMElements.newProductWeight.value; if (weight) { productName = `${productName} (${weight})`; } }Â 
Â if (barcode && inventoryCache.find(p => p.barcode === barcode)) {Â 
Â alert(`Error: Barcode '${barcode}' already exists.`);Â 
Â submitBtn.disabled = false;Â 
Â submitBtn.textContent = 'Create Product';
Â return;Â 
Â }Â 
Â const newProductData = { name: productName, barcode: barcode || null, category: category, user_id: currentUser.id };Â 
Â 
Â const { data: newProduct, error } = await db.from('products').insert(newProductData).select().single();Â 


Â if (error) {Â 
Â alert('Error creating product: ' + error.message);Â 
Â } else if (newProduct) {Â 
Â inventoryCache.push({ ...newProduct, batches: [], totalStock: 0 });Â 
Â inventoryCache.sort((a, b) => a.name.localeCompare(b.name));
Â renderInventoryTable();Â 
Â alert(`Product "${productName}" created successfully!`);Â 
Â hideAddProductModal();Â 
Â await loadDashboardData();Â 
Â } else {
Â alert('Product created, but failed to fetch updated data. Please refresh.');Â 
Â await loadInventory();Â 
Â hideAddProductModal();
Â }
Â 
Â submitBtn.disabled = false;Â 
Â submitBtn.textContent = 'Create Product';
Â }


Â function populateNewProductBarcode(barcodeText) { DOMElements.newProductBarcode.value = barcodeText; }
Â function showReceiveStockModal() { selectedProductForBatch = null; DOMElements.receiveStockForm.reset(); DOMElements.batchDetailsFields.classList.add('hidden'); DOMElements.confirmBatchBtn.disabled = true; DOMElements.productSearchInput.value = '';Â 
Â DOMElements.productSearchResults.classList.add('hidden'); showModal(DOMElements.receiveStockModal); DOMElements.productSearchInput.focus(); }
Â function hideReceiveStockModal() { hideModal(DOMElements.receiveStockModal); }
Â function handleProductSearch() { const term = DOMElements.productSearchInput.value.toLowerCase().trim(); if (term.length < 1) {Â 
Â DOMElements.productSearchResults.classList.add('hidden'); return; } const results = inventoryCache.filter(p => p.name.toLowerCase().includes(term) || (p.barcode && p.barcode.includes(term))); DOMElements.productSearchResults.innerHTML = ''; if (results.length > 0) { results.forEach(p => { const div = document.createElement('div'); div.className = 'p-2 hover:bg-gray-100 cursor-pointer border-b last:border-b-0'; div.textContent = `${p.name} (Stock: ${p.totalStock})`; div.onclick = () => selectProductForBatch(p); DOMElements.productSearchResults.appendChild(div); }); DOMElements.productSearchResults.classList.remove('hidden'); } else { DOMElements.productSearchResults.classList.add('hidden'); } }
Â function selectProductForBatch(product) { selectedProductForBatch = product; DOMElements.productSearchResults.classList.add('hidden'); DOMElements.productSearchInput.value = product.name; DOMElements.batchDetailsFields.classList.remove('hidden'); DOMElements.confirmBatchBtn.disabled = false; DOMElements.selectedProductName.textContent = product.name; DOMElements.batchQuantity.focus(); }
Â 
Â async function handleReceiveStockSubmit(e) {Â 
Â e.preventDefault();Â 
Â if (!selectedProductForBatch) { alert("Please select a product first."); return; }Â 


Â const submitBtn = DOMElements.confirmBatchBtn;
Â submitBtn.disabled = true;
Â submitBtn.textContent = 'Saving...';


Â const sellingPrice = parseFloat(DOMElements.batchSellingPrice.value);Â 
Â const quantity = parseInt(DOMElements.batchQuantity.value);
Â if (isNaN(quantity) || quantity <= 0) {
Â alert("Quantity must be a positive number.");
Â submitBtn.disabled = false;
Â submitBtn.textContent = 'Save Batch';
Â return;
Â }
Â const purchasePrice = parseFloat(DOMElements.batchPurchasePrice.value);
Â if (isNaN(purchasePrice) || isNaN(sellingPrice)) {
Â alert("Prices must be valid numbers.");
Â submitBtn.disabled = false;
Â submitBtn.textContent = 'Save Batch';
Â return;
Â }


Â const batchData = { product_id: selectedProductForBatch.id, user_id: currentUser.id, quantity_received: quantity, quantity_remaining: quantity, purchase_price: purchasePrice, selling_price: sellingPrice, expiry_date: DOMElements.batchExpiryDate.value || null, };Â 
Â 
Â const { data: newBatch, error } = await db.from('stock_batches').insert(batchData).select().single();Â 


Â if (error) {Â 
Â alert('Error saving batch: ' + error.message);Â 
Â } else if (newBatch) {Â 
Â const productIndex = inventoryCache.findIndex(p => p.id === selectedProductForBatch.id);
Â if (productIndex > -1) {
Â inventoryCache[productIndex].batches.push(newBatch);Â 
Â inventoryCache[productIndex].totalStock += newBatch.quantity_remaining;Â 
Â inventoryCache[productIndex].batches.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
Â } else {
Â console.error("Product not found in cache after adding batch, reloading full list.");
Â await loadInventory();Â 
Â hideReceiveStockModal();Â 
Â submitBtn.disabled = false;
Â submitBtn.textContent = 'Save Batch';
Â return;Â 
Â }


Â await db.from('products').update({ latest_selling_price: sellingPrice }).eq('id', selectedProductForBatch.id);Â 
Â 
Â renderInventoryTable();Â 
Â alert('New batch received successfully!');Â 
Â hideReceiveStockModal();Â 
Â await loadDashboardData();Â 
Â } else {
Â alert('Batch saved, but failed to update list. Please refresh.');
Â await loadInventory();Â 
Â hideReceiveStockModal();
Â }


Â submitBtn.disabled = false;
Â submitBtn.textContent = 'Save Batch';
Â }


Â function findProducts(term) { const lowerCaseTerm = term.toLowerCase(); return inventoryCache.filter(p => p.name.toLowerCase().includes(lowerCaseTerm) || (p.barcode && p.barcode.includes(term))); }


Â function processBarcode(barcodeText) {
Â const product = inventoryCache.find(p => p.barcode === barcodeText);
Â if (product) {
Â addProductToBill(product);
Â clearAndFocusSearch();
Â return;Â 
Â }


Â const results = findProducts(barcodeText);
Â if (results.length > 0) {
Â addProductToBill(results[0]);
Â clearAndFocusSearch();
Â } else {
Â alert('Product not found!');
Â }
Â }


Â function addProductToBill(product) {Â 
Â if (!product || product.totalStock <= 0) {Â 
Â alert(`${product ? product.name : 'Selected product'} is out of stock.`);Â 
Â return;Â 
Â }Â 
Â const cachedProduct = inventoryCache.find(p => p.id === product.id);
Â if (!cachedProduct || !cachedProduct.batches || cachedProduct.batches.length === 0) {
Â alert(`Error: ${product.name} has stock but no available batches found in cache. Please refresh.`);Â 
Â return;
Â }


Â const oldestBatch = cachedProduct.batches[0];Â 


Â if (!oldestBatch) {Â 
Â alert(`Internal Error: No oldest batch found for ${product.name} despite having stock.`);Â 
Â return;Â 
Â }


Â const existingItem = currentBill.find(item => item.batch_id === oldestBatch.id);Â 
Â 
Â if (existingItem) {Â 
Â if (existingItem.quantity < oldestBatch.quantity_remaining) {Â 
Â existingItem.quantity++;Â 
Â } else {Â 
Â alert(`Stock limit for this specific batch (${oldestBatch.quantity_remaining}) reached.`);Â 
Â }Â 
Â } else {Â 
Â if (oldestBatch.quantity_remaining > 0) {
Â currentBill.push({Â 
Â product_id: product.id,Â 
Â batch_id: oldestBatch.id,Â 
Â name: product.name,Â 
Â quantity: 1,Â 
Â price: oldestBatch.selling_price,Â 
Â purchase_price: oldestBatch.purchase_price,Â 
Â max_qty: oldestBatch.quantity_remaining,Â 
Â category: product.category,Â 
Â });Â 
Â } else {
Â alert(`Selected batch for ${product.name} just went out of stock. Please try adding again.`);
Â }
Â }Â 
Â renderBill();Â 
Â }
Â function renderBill() { DOMElements.billItemsBody.innerHTML = ''; DOMElements.billPlaceholder.classList.toggle('hidden', currentBill.length > 0); currentBill.forEach(item => { const row = `<tr class="border-b hover:bg-slate-50" data-batch-id="${item.batch_id}"><td class="p-3">${item.name} <span class="text-xs text-slate-500">(Batch #${item.batch_id.substring(0,4)})</span></td><td class="p-3">â‚¹${item.price.toFixed(2)}</td><td class="p-3"><div class="flex items-center justify-center"><button class="decrement-qty-btn bg-slate-200 rounded-full w-6 h-6 flex items-center justify-center hover:bg-slate-300">-</button><span class="px-3 font-semibold">${item.quantity}</span><button class="increment-qty-btn bg-slate-200 rounded-full w-6 h-6 flex items-center justify-center hover:bg-slate-300">+</button></div></td><td class="p-3 font-semibold">â‚¹${(item.price * item.quantity).toFixed(2)}</td><td class="p-3 text-center"><button class="remove-item-btn text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></td></tr>`; DOMElements.billItemsBody.insertAdjacentHTML('beforeend', row); }); updateBillSummary(); DOMElements.completeSaleBtn.disabled = currentBill.length === 0; }
Â function updateBillSummary() { const subtotal = currentBill.reduce((sum, item) => sum + (item.price * item.quantity), 0); const discount = currentBill.filter(item => item.category === 'General').reduce((sum, item) => sum + (item.price * item.quantity), 0) * 0.02; DOMElements.billSubtotal.textContent = `â‚¹${subtotal.toFixed(2)}`; DOMElements.billDiscount.textContent = `-â‚¹${discount.toFixed(2)}`; DOMElements.billTotal.textContent = `â‚¹${(subtotal - discount).toFixed(2)}`; }
Â function handleBillQuantityChange(batchId, change) { const item = currentBill.find(i => i.batch_id === batchId); if (!item) return; const newQuantity = item.quantity + change; if (change > 0) { if (newQuantity <= item.max_qty) { item.quantity = newQuantity; } else { alert(`Stock limit for this batch (${item.max_qty}) reached.`); } } else { if (newQuantity > 0) { item.quantity = newQuantity; } else { handleRemoveItem(batchId); } } renderBill(); }
Â function handleRemoveItem(batchId) { currentBill = currentBill.filter(item => item.batch_id !== batchId); renderBill(); }
Â function cancelSale() { currentBill = []; renderBill(); DOMElements.customerNameInput.value = ''; DOMElements.customerPhoneInput.value = ''; clearAndFocusSearch(); }Â 
Â function clearAndFocusSearch() { DOMElements.barcodeSearchInput.value = ''; DOMElements.searchResults.classList.add('hidden'); DOMElements.barcodeSearchInput.focus(); }


Â function handleBarcodeSearch(event) {
Â const searchTerm = DOMElements.barcodeSearchInput.value.trim();
Â if (event.key === 'Enter') {
Â if (!searchTerm) return;
Â processBarcode(searchTerm);Â 
Â } else {
Â if (searchTerm.length < 1) {Â 
Â DOMElements.searchResults.classList.add('hidden');
Â return;
Â }
Â renderSearchResults(findProducts(searchTerm));
Â }
Â }


Â function renderSearchResults(results) {Â 
Â if (results.length === 0) {Â 
Â DOMElements.searchResults.classList.add('hidden');Â 
Â return;Â 
Â }Â 
Â const inputRect = DOMElements.barcodeSearchInput.getBoundingClientRect();
Â DOMElements.searchResults.style.position = 'absolute';Â 
Â DOMElements.searchResults.style.top = `${inputRect.bottom + window.scrollY}px`;Â 
Â DOMElements.searchResults.style.left = `${inputRect.left + window.scrollX}px`;Â 
Â DOMElements.searchResults.style.width = `${inputRect.width}px`;
Â 
Â DOMElements.searchResults.innerHTML = results.map(p =>Â 
Â `<div class="p-3 hover:bg-slate-100 cursor-pointer search-result-item border-b last:border-b-0" data-id="${p.id}">
Â <p class="font-semibold">${p.name}</p>
Â <p class="text-sm text-slate-500">Barcode: ${p.barcode || 'N/A'} | Stock: ${p.totalStock}</p>
Â </div>`
Â ).join('');Â 
Â DOMElements.searchResults.classList.remove('hidden');Â 
Â }


Â function startCameraScanner(onSuccessCallback) { showModal(DOMElements.cameraScannerModal); const onScanSuccess = (decodedText, decodedResult) => { if (navigator.vibrate) navigator.vibrate(100); stopCameraScanner(); onSuccessCallback(decodedText); }; const config = { fps: 10, qrbox: { width: 250, height: 250 } }; cameraScanner = new Html5Qrcode("reader"); cameraScanner.start({ facingMode: "environment" }, config, onScanSuccess, (errorMessage) => { /* console.log(`QR Code no longer in front of camera.`); */ }).catch(err => { console.error("FATAL: Camera start error:", err); stopCameraScanner(); alert("Could not start camera. Please ensure permissions are granted and no other app is using it."); }); }
Â function stopCameraScanner() { if (cameraScanner && cameraScanner.isScanning) { cameraScanner.stop().catch(err => console.error("Error stopping scanner:", err)).finally(() => { hideModal(DOMElements.cameraScannerModal); cameraScanner = null; }); } else { hideModal(DOMElements.cameraScannerModal); } }
Â function processInventoryScan(barcodeText) { const product = inventoryCache.find(p => p.barcode === barcodeText); if (product) { selectProductForBatch(product); } else { alert('Product not found. Please add it as a new product first.'); } }
Â function showReceiptPreview() { DOMElements.receiptDate.textContent = new Date().toLocaleString('en-IN'); DOMElements.receiptCustomer.textContent = DOMElements.customerNameInput.value ? `Customer: ${DOMElements.customerNameInput.value}` : ''; DOMElements.receiptItems.innerHTML = currentBill.map(item => `<div class="grid grid-cols-12 gap-1"><div class="col-span-5">${item.name}</div><div class="col-span-2 text-right">${item.quantity}</div><div class="col-span-2 text-right">@${item.price.toFixed(2)}</div><div class="col-span-3 text-right">â‚¹${(item.price * item.quantity).toFixed(2)}</div></div>`).join(''); DOMElements.receiptSubtotal.textContent = DOMElements.billSubtotal.textContent; DOMElements.receiptDiscount.textContent = DOMElements.billDiscount.textContent; DOMElements.receiptTotal.textContent = DOMElements.billTotal.textContent; showModal(DOMElements.receiptModal); }
Â 
Â // --- Bluetooth Printer Functions ---
Â async function connectPrinter() {
Â const connectBtn = DOMElements.connectPrinterBtn;
Â if (printerDevice && printerDevice.gatt.connected) {Â 
Â alert('Printer is already connected.');
Â return;
Â }
Â try {
Â connectBtn.textContent = 'Connecting...';
Â connectBtn.disabled = true;


Â const SERVICE_UUID = '000018f0-0000-1000-8000-00805f9b34fb';
Â const CHARACTERISTIC_UUID = '00002af1-0000-1000-8000-00805f9b34fb';


Â printerDevice = await navigator.bluetooth.requestDevice({
Â  Â  // filters: [{ services: [SERVICE_UUID] }], // Temporarily disable service filter
Â  Â  acceptAllDevices: true, // Show ALL nearby Bluetooth devices
Â  Â  optionalServices: [SERVICE_UUID] // Still request the service later if we connect
});


Â const server = await printerDevice.gatt.connect();
Â const service = await server.getPrimaryService(SERVICE_UUID);
Â printerCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);


Â alert('Printer Connected Successfully!');
Â connectBtn.textContent = 'Printer Connected';
Â connectBtn.classList.remove('bg-blue-600');
Â connectBtn.classList.add('bg-green-600');
Â connectBtn.disabled = false;


Â printerDevice.addEventListener('gattserverdisconnected', () => {
Â console.log('Printer disconnected event');Â 
Â alert('Printer disconnected.');
Â printerDevice = null;
Â printerCharacteristic = null;
Â connectBtn.textContent = 'Connect Printer';
Â connectBtn.disabled = false;
Â connectBtn.classList.add('bg-blue-600');
Â connectBtn.classList.remove('bg-green-600');
Â });


Â } catch (error) {
Â console.error('Bluetooth Connection Error:', error);
Â alert(`Connection failed: ${error.message}\n\nNote: Web Bluetooth requires an HTTPS connection (a deployed website). Ensure Bluetooth is ON.`);
Â connectBtn.textContent = 'Connect Printer';
Â connectBtn.disabled = false;Â 
Â printerDevice = null;
Â printerCharacteristic = null;
Â }
Â }


Â // --- THIS IS THE CORRECT, SINGLE handleDirectPrint FUNCTION ---
Â async function handleDirectPrint() {
Â // Check if this is a reprint action
Â const reprintDataStr = DOMElements.directPrintBtn.dataset.reprintData;
Â let isReprint = false;
Â let saleDataForPrint;


Â if (reprintDataStr) {
Â isReprint = true;
Â try {
Â saleDataForPrint = JSON.parse(reprintDataStr);
Â } catch (e) {
Â console.error("Failed to parse reprint data:", e);
Â alert("Error preparing reprint data.");
Â delete DOMElements.directPrintBtn.dataset.reprintData; // Clear invalid data
Â return;
Â }
Â delete DOMElements.directPrintBtn.dataset.reprintData; // Clear after use
Â console.log("Handling reprint for sale:", saleDataForPrint.id);
Â } else {
Â // This is a new sale
Â if (currentBill.length === 0) {
Â alert('Bill is empty.');
Â return;
Â }
Â console.log("Handling new sale");
Â }




Â if (!printerCharacteristic || !printerDevice || !printerDevice.gatt.connected) {Â 
Â alert('Printer not connected or connection lost. Please connect from the main menu first.');
Â DOMElements.connectPrinterBtn.textContent = 'Connect Printer';
Â DOMElements.connectPrinterBtn.disabled = false;
Â DOMElements.connectPrinterBtn.classList.add('bg-blue-600');
Â DOMElements.connectPrinterBtn.classList.remove('bg-green-600');
Â printerDevice = null;
Â printerCharacteristic = null;
Â return;
Â }


Â DOMElements.directPrintBtn.disabled = true;
Â DOMElements.directPrintBtn.textContent = isReprint ? 'Reprinting...' : 'Printing...';


Â // --- If it's a NEW sale, save data first ---
Â if (!isReprint) {
Â const total = parseFloat(DOMElements.billTotal.textContent.replace('â‚¹', ''));
Â saleDataForPrint = { // Use saleDataForPrint to hold the data for printing
Â user_id: currentUser.id,
Â items: currentBill.map(item => ({ product_id: item.product_id, batch_id: item.batch_id, name: item.name, quantity: item.quantity, price: item.price, purchase_price: item.purchase_price })),
Â subtotal: parseFloat(DOMElements.billSubtotal.textContent.replace('â‚¹', '')),
Â discount: parseFloat(DOMElements.billDiscount.textContent.replace('-â‚¹', '')),
Â total: total,
Â customer_name: DOMElements.customerNameInput.value.trim() || null,Â 
Â customer_phone: DOMElements.customerPhoneInput.value.trim() || null,
Â created_at: new Date().toISOString()Â 
Â };


Â try {
Â const { data: insertedSale, error: saleError } = await db.from('sales').insert([saleDataForPrint]).select().single();Â 
Â if (saleError) throw saleError;Â 
Â if (!insertedSale) throw new Error("Sale insert did not return data.");
Â 
Â const batchUpdates = insertedSale.items.map(item => {
Â const originalBillItem = currentBill.find(b => b.batch_id === item.batch_id);Â 
Â if (!originalBillItem) throw new Error(`Could not find original bill item for batch ${item.batch_id} during stock update`);
Â 
Â const newRemaining = originalBillItem.max_qty - item.quantity;


Â return db.from('stock_batches')
Â .update({ quantity_remaining: Math.max(0, newRemaining) })Â 
Â .eq('id', item.batch_id);
Â });
Â await Promise.all(batchUpdates);
Â 
Â saleDataForPrint = {...saleDataForPrint, ...insertedSale};Â 


Â } catch (dbError) {
Â alert('CRITICAL: Error saving sale or updating stock: ' + dbError.message);
Â console.error("Database Error during Sale:", dbError);
Â DOMElements.directPrintBtn.disabled = false;
Â DOMElements.directPrintBtn.textContent = 'Direct Bluetooth Print';
Â return;Â 
Â }
Â } // End if(!isReprint) for saving data


Â // --- Proceed to Print (applies to both new sales and reprints) ---
Â try {
Â const encoder = new TextEncoder();
Â 
Â const ESC = 0x1B; const GS = 0x1D; const NUL = 0x00;
Â const INIT = [ESC, 0x40];Â 
Â const ALIGN_LEFT = [ESC, 0x61, 0x00];
Â const ALIGN_CENTER = [ESC, 0x61, 0x01];
Â const ALIGN_RIGHT = [ESC, 0x61, 0x02];
Â const BOLD_ON = [ESC, 0x45, 0x01];
Â const BOLD_OFF = [ESC, 0x45, 0x00];
Â const CUT_PAPER = [GS, 0x56, 0x41];Â 
Â const LINE_FEED = [0x0A];Â 


Â const send = async (data) => {Â 
Â const MAX_CHUNK = 100;Â 
Â let buffer = new Uint8Array(data);
Â for (let i = 0; i < buffer.length; i += MAX_CHUNK) {
Â let chunk = buffer.slice(i, i + MAX_CHUNK);
Â await printerCharacteristic.writeValueWithoutResponse(chunk);
Â }
Â };
Â const sendLine = async (text = '', align = ALIGN_LEFT, bold = false) => {Â 
Â let command = [...align];
Â if (bold) command = [...command, ...BOLD_ON];
Â command = [...command, ...encoder.encode(text), ...LINE_FEED];Â 
Â if (bold) command = [...command, ...BOLD_OFF];
Â await send(command);
Â };
Â 
Â await send(INIT);
Â await sendLine('VEDA KIRANA AND GENERAL STORE', ALIGN_CENTER, true);
Â await sendLine('Ratna Complex, 509338', ALIGN_CENTER);
Â await sendLine('Phone: 8309913409', ALIGN_CENTER);
Â await sendLine();Â 
Â await sendLine(`Date: ${new Date(saleDataForPrint.created_at).toLocaleString('en-IN')}`, ALIGN_LEFT);Â 
Â if (saleDataForPrint.customer_name) {
Â await sendLine(`Customer: ${saleDataForPrint.customer_name}`, ALIGN_LEFT);
Â }
Â if (isReprint) {Â 
Â await sendLine('*** DUPLICATE RECEIPT ***', ALIGN_CENTER, true);
Â }
Â await sendLine('--------------------------------', ALIGN_CENTER);


Â await sendLine('ItemÂ  Â  Â  Â QtyÂ  Â PriceÂ  Â  Â Total', ALIGN_LEFT, true);
Â 
Â for (const item of saleDataForPrint.items) {Â 
Â const name = item.name.substring(0, 10).padEnd(11);
Â const qty = item.quantity.toString().padEnd(5);
Â const price = item.price.toFixed(2).padStart(7);
Â const itemTotal = (item.price * item.quantity).toFixed(2).padStart(7);
Â await sendLine(`${name}${qty}${price}${itemTotal}`, ALIGN_LEFT);
Â }
Â 
Â await sendLine('--------------------------------', ALIGN_CENTER);


Â await sendLine(`Subtotal: ${saleDataForPrint.subtotal.toFixed(2).padStart(18)}`, ALIGN_RIGHT);
Â await sendLine(`Discount: ${saleDataForPrint.discount.toFixed(2).padStart(18)}`, ALIGN_RIGHT);
Â await sendLine(`TOTAL: ${saleDataForPrint.total.toFixed(2).padStart(23)}`, ALIGN_RIGHT, true);
Â await sendLine();Â 
Â 
Â await sendLine('Thank you for your visit!', ALIGN_CENTER);
Â await sendLine();Â 
Â await sendLine();Â 
Â await send(CUT_PAPER);


Â // --- Success: Reset UI ONLY if it was a NEW sale ---
Â if (!isReprint) {
Â hideModal(DOMElements.receiptModal);
Â cancelSale();Â 
Â await loadInventory();Â 
Â await loadSalesHistory();Â 
Â } else {
Â // If reprint, just close the modal
Â hideModal(DOMElements.receiptModal);
Â }


Â } catch (printError) {
Â console.error('Printing Error:', printError);
Â alert(`${isReprint ? 'Reprint failed' : 'Sale SAVED, but printing failed'}: ${printError.message}\nCheck printer connection and power.`);
Â hideModal(DOMElements.receiptModal);
Â if (!isReprint) {
Â cancelSale();Â 
Â await loadInventory();Â 
Â await loadSalesHistory();Â 
Â }
Â } finally {
Â DOMElements.directPrintBtn.disabled = false;
Â DOMElements.directPrintBtn.textContent = 'Direct Bluetooth Print';
Â }
Â } // End handleDirectPrint




Â // --- History, Reports, AI ---Â 
Â async function loadSalesHistory(filters = {}) { let query = db.from('sales').select('*, items'); if (filters.startDate) { const startDate = new Date(filters.startDate); startDate.setHours(0, 0, 0, 0); query = query.gte('created_at', startDate.toISOString()); } if (filters.endDate) { const endDate = new Date(filters.endDate); endDate.setHours(23, 59, 59, 999); query = query.lt('created_at', endDate.toISOString()); } if (filters.customerName) { query = query.ilike('customer_name', `%${filters.customerName}%`); } if (!filters.startDate && !filters.endDate) { const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); thirtyDaysAgo.setHours(0, 0, 0, 0); query = query.gte('created_at', thirtyDaysAgo.toISOString()); } const { data, error } = await query.order('created_at', { ascending: false }); if (error) { console.error('Error fetching history:', error); salesHistoryCache = []; } else { salesHistoryCache = data.map(sale => { let saleProfit = 0; if(sale.items && Array.isArray(sale.items)) { sale.items.forEach(item => {Â 
Â const purchasePrice = (typeof item.purchase_price === 'number') ? item.purchase_price : 0;
Â saleProfit += (item.price - purchasePrice) * item.quantity; }); } return { ...sale, profit: saleProfit }; }); } renderHistoryTable(); }
Â function renderHistoryTable() { DOMElements.historyTableBody.innerHTML = ''; if (salesHistoryCache.length === 0) { DOMElements.historyTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-slate-500">No sales found for selected period.</td></tr>`; return; } salesHistoryCache.forEach(sale => { const row = `<tr class="border-b hover:bg-slate-50 cursor-pointer history-row" data-id="${sale.id}"><td class="p-3">${new Date(sale.created_at).toLocaleString('en-IN')}</td><td class="p-3">${sale.customer_name || 'N/A'}</td><td class="p-3 font-semibold">â‚¹${sale.total.toFixed(2)}</td><td class="p-3"><button class="reprint-btn text-blue-500 hover:text-blue-700" data-id="${sale.id}" title="Reprint Receipt"><i class="fas fa-print"></i></button></td></tr>`; DOMElements.historyTableBody.insertAdjacentHTML('beforeend', row); }); }
Â function showHistoryDetail(saleId) { const sale = salesHistoryCache.find(s => s.id === saleId); if (!sale || !sale.items || !Array.isArray(sale.items)) { console.error("Sale data invalid for detail view:", sale); return; } DOMElements.historyDetailCustomer.textContent = `Customer: ${sale.customer_name || 'N/A'}`; DOMElements.historyDetailDate.textContent = `Billed on: ${new Date(sale.created_at).toLocaleString('en-IN')}`; DOMElements.historyDetailItems.innerHTML = sale.items.map(item => { const purchasePrice = (typeof item.purchase_price === 'number') ? item.purchase_price : 0; const profit = (item.price - purchasePrice) * item.quantity; return `<tr class="border-b"><td class="p-2">${item.name}</td><td class="p-2 text-center">${item.quantity}</td><td class="p-2">â‚¹${item.price.toFixed(2)}</td><td class="p-2 text-green-600">â‚¹${profit.toFixed(2)}</td><td class="p-2 text-right font-semibold">â‚¹${(item.price * item.quantity).toFixed(2)}</td></tr>`;}).join(''); DOMElements.historyDetailTotalProfit.textContent = `â‚¹${(sale.profit || 0).toFixed(2)}`; showModal(DOMElements.historyDetailModal); }
Â 
Â // Updated handleReprint to setup data for handleDirectPrint
Â async function handleReprint(saleId) {Â 
Â const sale = salesHistoryCache.find(s => s.id === saleId);Â 
Â if (!sale || !sale.items || !Array.isArray(sale.items)) {Â 
Â alert("Cannot reprint - sale data missing or invalid.");Â 
Â return;Â 
Â }Â 
Â 
Â // Populate modal fields first
Â DOMElements.receiptDate.textContent = new Date(sale.created_at).toLocaleString('en-IN');Â 
Â DOMElements.receiptCustomer.textContent = sale.customer_name ? `Customer: ${sale.customer_name}` : '';Â 
Â DOMElements.receiptItems.innerHTML = sale.items.map(item =>Â 
Â `<div class="grid grid-cols-12 gap-1"><div class="col-span-5">${item.name}</div><div class="col-span-2 text-right">${item.quantity}</div><div class="col-span-2 text-right">@${item.price.toFixed(2)}</div><div class="col-span-3 text-right">â‚¹${(item.price * item.quantity).toFixed(2)}</div></div>`
Â ).join('');Â 
Â DOMElements.receiptSubtotal.textContent = `â‚¹${sale.subtotal.toFixed(2)}`;Â 
Â DOMElements.receiptDiscount.textContent = `-â‚¹${sale.discount.toFixed(2)}`;Â 
Â DOMElements.receiptTotal.textContent = `â‚¹${sale.total.toFixed(2)}`;Â 
Â 
Â // Store the sale data needed for direct print on the button
Â DOMElements.directPrintBtn.dataset.reprintData = JSON.stringify(sale);


Â showModal(DOMElements.receiptModal);Â 
Â }


Â async function loadReportsData() { const ninetyDaysAgo = new Date(); ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90); const { data: sales, error } = await db.from('sales').select('items').gte('created_at', ninetyDaysAgo.toISOString()); if (error) { console.error("Error fetching reports:", error); return; } const productSales = {}; if (sales) { sales.forEach(sale => { if (sale.items && Array.isArray(sale.items)) { sale.items.forEach(item => { productSales[item.product_id] = (productSales[item.product_id] || 0) + item.quantity; }); } }); } const salesArray = inventoryCache.map(p => ({ id: p.id, name: p.name, totalStock: p.totalStock, unitsSold: productSales[p.id] || 0 })); const fastMoving = [...salesArray].filter(p => p.unitsSold > 0).sort((a, b) => b.unitsSold - a.unitsSold).slice(0, 10); const slowMoving = [...salesArray].filter(p => p.totalStock > 0).sort((a, b) => a.unitsSold - b.unitsSold).slice(0, 10); renderReports(fastMoving, slowMoving); }
Â function renderReports(fastMoving, slowMoving) { DOMElements.fastMovingTable.innerHTML = fastMoving.map(p => `<tr class="border-b"><td class="p-2">${p.name}</td><td class="p-2 text-right font-bold">${p.unitsSold}</td><td class="p-2 text-right">${p.totalStock}</td></tr>`).join('') || `<tr><td colspan="3" class="p-4 text-center text-slate-500">Not enough sales data for fast-moving report.</td></tr>`; DOMElements.slowMovingTable.innerHTML = slowMoving.map(p => `<tr class="border-b"><td class="p-2">${p.name}</td><td class="p-2 text-right font-bold">${p.unitsSold}</td><td class="p-2 text-right">${p.totalStock}</td></tr>`).join('') || `<tr><td colspan="3" class="p-4 text-center text-slate-500">Not enough inventory data for slow-moving report.</td></tr>`; }
Â async function getAiSalesSummary() { /* AI functions need implementation */ alert("AI Summary not implemented yet.");}
Â async function getRecipeIdea() { /* AI functions need implementation */ alert("AI Recipe Idea not implemented yet.");}
Â let geminiApiKey = localStorage.getItem('geminiApiKey'); function getGeminiApiKey() { if (!geminiApiKey) { geminiApiKey = prompt("Please enter your Google Gemini API Key."); if (geminiApiKey) { localStorage.setItem('geminiApiKey', geminiApiKey); } } return geminiApiKey; } async function callGemini(prompt) { /* AI functions need implementation */ return null; }


Â // --- Event Listeners ---
Â DOMElements.signinBtn.addEventListener('click', handleSignIn);
Â DOMElements.signupBtn.addEventListener('click', handleSignUp);
Â DOMElements.googleSigninBtn.addEventListener('click', handleGoogleSignIn);
Â DOMElements.logoutBtns.forEach(btn => btn.addEventListener('click', handleSignOut));
Â DOMElements.navLinks.forEach(link => link.addEventListener('click', () => switchView(link.dataset.view)));
Â DOMElements.lowStockCard.addEventListener('click', () => switchView('inventory', { lowStockOnly: true }));
Â DOMElements.expiringSoonCard.addEventListener('click', () => switchView('inventory', { expiringSoon: true }));
Â DOMElements.inventoryHeader.addEventListener('click', (e) => { if (e.target.id === 'show-all-btn') { renderInventoryTable(); } });
Â DOMElements.addProductBtn.addEventListener('click', showAddProductModal);
Â DOMElements.cancelAddProductModalBtn.addEventListener('click', hideAddProductModal);
Â DOMElements.addProductForm.addEventListener('submit', handleAddProductSubmit);
Â DOMElements.newProductCategory.addEventListener('change', (e) => { DOMElements.newProductWeightContainer.classList.toggle('hidden', e.target.value !== 'Kirana'); });
Â DOMElements.receiveStockBtn.addEventListener('click', showReceiveStockModal);
Â DOMElements.cancelReceiveStockModal.addEventListener('click', hideReceiveStockModal);
Â DOMElements.productSearchInput.addEventListener('input', handleProductSearch);Â 
Â DOMElements.receiveStockForm.addEventListener('submit', handleReceiveStockSubmit);
Â DOMElements.inventoryTableBody.addEventListener('click', (e) => { const deleteBtn = e.target.closest('.delete-product-btn'); if (deleteBtn) { handleDeleteProduct(deleteBtn.dataset.id, deleteBtn.dataset.name); } });
Â DOMElements.barcodeSearchInput.addEventListener('keyup', handleBarcodeSearch);Â 
Â 
Â DOMElements.searchResults.addEventListener('click', (e) => {
Â const itemEl = e.target.closest('.search-result-item');
Â if (itemEl) {
Â const product = inventoryCache.find(p => p.id === itemEl.dataset.id);
Â if (product) {
Â addProductToBill(product);
Â DOMElements.searchResults.classList.add('hidden');Â 
Â DOMElements.barcodeSearchInput.focus();Â 
Â }
Â }
Â });


Â // Hide search results when clicking outside
Â document.addEventListener('click', (event) => {Â 
Â if (DOMElements.barcodeSearchInput && !DOMElements.barcodeSearchInput.contains(event.target) && DOMElements.searchResults && !DOMElements.searchResults.contains(event.target)) {Â 
Â DOMElements.searchResults.classList.add('hidden');Â 
Â }Â 
Â if (DOMElements.productSearchInput && !DOMElements.productSearchInput.contains(event.target) && DOMElements.productSearchResults && !DOMElements.productSearchResults.contains(event.target)) {Â 
Â DOMElements.productSearchResults.classList.add('hidden');Â 
Â }Â 
Â });
Â DOMElements.billItemsBody.addEventListener('click', (e) => { const row = e.target.closest('tr'); if (!row || !row.dataset.batchId) return; const batchId = row.dataset.batchId; if (e.target.closest('.increment-qty-btn')) { handleBillQuantityChange(batchId, 1); } if (e.target.closest('.decrement-qty-btn')) { handleBillQuantityChange(batchId, -1); } if (e.target.closest('.remove-item-btn')) { handleRemoveItem(batchId); } });
Â DOMElements.cancelSaleBtn.addEventListener('click', cancelSale);
Â DOMElements.completeSaleBtn.addEventListener('click', showReceiptPreview);Â 
Â DOMElements.cancelReceiptBtn.addEventListener('click', () => {
Â hideModal(DOMElements.receiptModal);
Â delete DOMElements.directPrintBtn.dataset.reprintData;Â 
Â });Â 
Â DOMElements.directPrintBtn.addEventListener('click', handleDirectPrint);Â 
Â DOMElements.historySearchInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') { DOMElements.filterByDateBtn.click(); }});
Â DOMElements.filterByDateBtn.addEventListener('click', () => { const filters = { startDate: DOMElements.startDateInput.value, endDate: DOMElements.endDateInput.value, customerName: DOMElements.historySearchInput.value.trim() }; loadSalesHistory(filters); });
Â DOMElements.clearFilterBtn.addEventListener('click', () => { DOMElements.startDateInput.value = ''; DOMElements.endDateInput.value = ''; DOMElements.historySearchInput.value = ''; loadSalesHistory(); });
Â DOMElements.historyTableBody.addEventListener('click', e => { const reprintBtn = e.target.closest('.reprint-btn'); if (reprintBtn) { e.stopPropagation(); handleReprint(reprintBtn.dataset.id); return; } const row = e.target.closest('.history-row'); if (row) { showHistoryDetail(row.dataset.id); } });
Â DOMElements.closeHistoryDetailModalBtn.addEventListener('click', () => hideModal(DOMElements.historyDetailModal));
Â DOMElements.aiSummaryBtn.addEventListener('click', getAiSalesSummary);
Â DOMElements.recipeAiBtn.addEventListener('click', getRecipeIdea);
Â DOMElements.closeAiModalBtn.addEventListener('click', () => hideModal(DOMElements.aiModal));
Â DOMElements.scanWithCameraBtn.addEventListener('click', () => startCameraScanner(processBarcode));
Â DOMElements.inventoryScanBtn.addEventListener('click', () => startCameraScanner(processInventoryScan));
Â DOMElements.addProductScanBtn.addEventListener('click', () => startCameraScanner(populateNewProductBarcode));
Â DOMElements.cancelScanBtn.addEventListener('click', stopCameraScanner);
Â DOMElements.connectPrinterBtn.addEventListener('click', connectPrinter);
</script>


</body>
</html>  
